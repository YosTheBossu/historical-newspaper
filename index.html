<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>היום בהיסטוריה - העיתון היומי</title>
    <link rel="stylesheet" href="style.css">
    <link href="https://fonts.googleapis.com/css2?family=Heebo:wght@300;400;700;900&family=Frank+Ruhl+Libre:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>
    <div class="container">
        <!-- כותרת העיתון -->
        <header class="newspaper-header">
            <div class="date-line">
                <span class="date" id="currentDate">טוען...</span>
                <span class="hebrew-date" id="hebrewDate"></span>
                <span class="edition">העיתון היומי של ההיסטוריה | מהדורה דיגיטלית</span>
            </div>
            <h1 class="newspaper-title">היום בהיסטוריה</h1>
            <div class="subtitle" id="dailyHeadline">העיתון שמחיה את העבר - נתונים חיים מויקיפדיה העברית</div>
            <div class="header-line"></div>

            <div class="controls">
                <button onclick="changeDate(-1)" class="control-btn">
                    <i class="fas fa-chevron-right"></i> אתמול
                </button>
                <button onclick="goToToday()" class="control-btn today-btn">
                    <i class="fas fa-calendar-day"></i> היום
                </button>
                <button onclick="changeDate(1)" class="control-btn">
                    מחר <i class="fas fa-chevron-left"></i>
                </button>
            </div>
        </header>

        <!-- טעינה -->
        <div id="loading" class="loading-indicator">
            <div class="spinner"></div>
            <p>טוען אירועים היסטוריים מויקיפדיה העברית...</p>
        </div>

        <!-- שגיאה -->
        <div id="errorMsg" class="error-message" style="display:none;">
            <i class="fas fa-exclamation-triangle"></i>
            <p>לא הצלחנו לטעון נתונים. נסה לרענן את הדף.</p>
            <button onclick="loadEventsForDate()" class="control-btn">נסה שוב</button>
        </div>

        <!-- תוכן דינמי -->
        <div id="content" style="display: none;">
            <!-- כותרת ראשית -->
            <section id="mainHeadline" class="main-headline"></section>

            <!-- אירועים + ציוצים בצד -->
            <div class="article-with-tweet">
                <div class="article-content">
                    <section class="news-section">
                        <h3><i class="fas fa-landmark"></i> אירועים</h3>
                        <div id="eventsContent"></div>
                    </section>
                </div>
                <div class="tweet-sidebar" id="tweetsSection">
                    <h3 class="sidebar-title"><i class="fab fa-twitter"></i> מה היו מצייצים?</h3>
                    <div id="tweetsContent"></div>
                </div>
            </div>

            <!-- עמודות - נולדו ונפטרו -->
            <div class="columns">
                <div class="column">
                    <section class="news-section">
                        <h3><i class="fas fa-birthday-cake"></i> נולדו היום</h3>
                        <div id="birthsContent"></div>
                    </section>
                </div>
                <div class="column">
                    <section class="news-section">
                        <h3><i class="fas fa-star-of-life"></i> נפטרו היום</h3>
                        <div id="deathsContent"></div>
                    </section>
                </div>
            </div>

            <!-- ציר זמן -->
            <section class="news-section">
                <h3><i class="fas fa-calendar-alt"></i> עוד היום בהיסטוריה</h3>
                <ul id="timelineContent" class="timeline"></ul>
            </section>
        </div>

        <!-- פוטר -->
        <footer class="newspaper-footer">
            <div class="footer-line"></div>
            <div class="footer-content">
                <div class="footer-section">
                    <h4>אודות העיתון</h4>
                    <p>"היום בהיסטוריה" מביא לכם בכל יום את האירועים החשובים שהתרחשו בתאריך הזה לאורך השנים.</p>
                </div>
                <div class="footer-section">
                    <h4>מקור הנתונים</h4>
                    <p>הנתונים מגיעים מויקיפדיה העברית. התוכן מתעדכן אוטומטית בכל יום.</p>
                </div>
                <div class="footer-section">
                    <h4>צרו קשר</h4>
                    <p>הצעות, תיקונים, רעיונות?<br>history@newspaper.co.il</p>
                </div>
            </div>
            <div class="copyright">
                &copy; 2026 "היום בהיסטוריה" - כל הזכויות שמורות | נתונים: ויקיפדיה העברית
            </div>
        </footer>
    </div>

    <script>
    // ====== State ======
    let currentDate = new Date();
    let pageData = null;

    const HEBREW_MONTHS = ['ינואר','פברואר','מרץ','אפריל','מאי','יוני',
                           'יולי','אוגוסט','ספטמבר','אוקטובר','נובמבר','דצמבר'];

    // ====== Date helpers ======
    function updateDateDisplay() {
        const opts = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
        document.getElementById('currentDate').textContent =
            currentDate.toLocaleDateString('he-IL', opts);
        fetchHebrewDate();
    }

    // Fetch Hebrew date from Hebcal API
    async function fetchHebrewDate() {
        try {
            const y = currentDate.getFullYear();
            const m = currentDate.getMonth() + 1;
            const d = currentDate.getDate();
            const url = `https://www.hebcal.com/converter?cfg=json&gy=${y}&gm=${m}&gd=${d}&g2h=1`;
            const resp = await fetch(url);
            if (!resp.ok) return;
            const data = await resp.json();
            const heb = data.hebrew || '';
            document.getElementById('hebrewDate').textContent = heb;
        } catch (e) { /* silent fail */ }
    }

    function changeDate(days) {
        currentDate = new Date(currentDate.getTime() + days * 86400000);
        updateDateDisplay();
        loadEventsForDate();
    }

    function goToToday() {
        currentDate = new Date();
        updateDateDisplay();
        loadEventsForDate();
    }

    // ====== Fetch from Hebrew Wikipedia (wikitext) ======
    async function fetchHebrewWikiPage(day, month) {
        const monthName = HEBREW_MONTHS[month];
        const pageName = `${day}_ב${monthName}`;
        const url = `https://he.wikipedia.org/w/api.php?action=parse&page=${encodeURIComponent(pageName)}&format=json&prop=wikitext&origin=*`;
        const resp = await fetch(url);
        if (!resp.ok) throw new Error(`HTTP ${resp.status}`);
        const data = await resp.json();
        if (data.error) throw new Error(data.error.info);
        return parseWikitext(data.parse.wikitext['*']);
    }

    // ====== Parse Wikitext ======
    function parseWikitext(wikitext) {
        const result = { events: [], births: [], deaths: [] };
        let currentSection = '';

        const lines = wikitext.split('\n');
        for (const line of lines) {
            const trimmed = line.trim();

            // Detect section headers: == אירועים ==
            const sectionMatch = trimmed.match(/^==\s*(.+?)\s*==$/);
            if (sectionMatch) {
                const name = sectionMatch[1].trim();
                if (name === 'אירועים') currentSection = 'events';
                else if (name === 'לידות') currentSection = 'births';
                else if (name === 'פטירות') currentSection = 'deaths';
                else currentSection = '';
                continue;
            }

            // Parse list items: * [[1949]] – description
            if (currentSection && trimmed.startsWith('*')) {
                const parsed = parseWikitextItem(trimmed);
                if (parsed) result[currentSection].push(parsed);
            }
        }
        return result;
    }

    function parseWikitextItem(line) {
        // Remove leading * and whitespace
        let text = line.replace(/^\*\s*/, '');

        // Extract year: [[1949]] or 1949
        const yearMatch = text.match(/^\[?\[?(\d{1,4})\]?\]?\s*[-–—]\s*/);
        if (!yearMatch) return null;

        const year = parseInt(yearMatch[1]);
        text = text.substring(yearMatch[0].length);

        // Convert [[link|display]] to display text and extract first link
        let wikiUrl = null;
        const description = text.replace(/\[\[([^\]|]+)\|?([^\]]*)\]\]/g, (match, target, display) => {
            if (!wikiUrl) wikiUrl = `https://he.wikipedia.org/wiki/${encodeURIComponent(target.replace(/ /g, '_'))}`;
            return display || target;
        });

        // Clean remaining wiki markup
        const cleanDesc = description
            .replace(/'''(.+?)'''/g, '$1')  // bold
            .replace(/''(.+?)''/g, '$1')    // italic
            .replace(/\{\{[^}]+\}\}/g, '')  // templates
            .replace(/<ref[^>]*>.*?<\/ref>/g, '') // references
            .replace(/<ref[^/]*\/>/g, '')    // self-closing refs
            .trim();

        return { year, description: cleanDesc, wikiUrl };
    }

    // ====== Main loader ======
    async function loadEventsForDate() {
        document.getElementById('loading').style.display = 'block';
        document.getElementById('content').style.display = 'none';
        document.getElementById('errorMsg').style.display = 'none';

        const day = currentDate.getDate();
        const month = currentDate.getMonth();

        try {
            pageData = await fetchHebrewWikiPage(day, month);
            document.getElementById('loading').style.display = 'none';
            document.getElementById('content').style.display = 'block';
            renderAll();
        } catch (err) {
            console.error('Fetch error:', err);
            document.getElementById('loading').style.display = 'none';
            document.getElementById('errorMsg').style.display = 'flex';
        }
    }

    // ====== Render ======
    function renderAll() {
        if (!pageData) return;
        renderMainHeadline();
        renderEvents();
        renderBirths();
        renderDeaths();
        renderTweets();
        renderTimeline();
    }

    function yearsAgo(year) {
        if (!year) return '';
        const diff = currentDate.getFullYear() - year;
        if (diff === 0) return 'השנה';
        if (diff === 1) return 'לפני שנה';
        return `לפני ${diff} שנים`;
    }

    // Main headline
    function renderMainHeadline() {
        const events = pageData.events || [];
        if (events.length === 0) {
            document.getElementById('mainHeadline').innerHTML =
                '<h2>לא נמצאו אירועים בולטים לתאריך זה</h2>';
            return;
        }

        // Pick a significant event (prefer recent, important events)
        const ev = events[events.length - 1]; // Most recent event
        const ago = yearsAgo(ev.year);

        document.getElementById('mainHeadline').innerHTML = `
            <div class="headline-category">אירוע מרכזי</div>
            <h2>${ev.year} - ${ev.description}</h2>
            <div class="headline-meta">
                <span class="byline">מקור: ויקיפדיה העברית</span>
                <span class="time">${ago ? '&#128336; ' + ago : ''}</span>
            </div>
            <div class="headline-content">
                <p>${ev.description}</p>
                ${ev.wikiUrl ? `<a href="${ev.wikiUrl}" target="_blank" class="read-more">קרא עוד בויקיפדיה &larr;</a>` : ''}
            </div>
        `;

        document.getElementById('dailyHeadline').textContent =
            `${ago} | ${ev.description.substring(0, 70)}${ev.description.length > 70 ? '...' : ''}`;
    }

    // Events list
    function renderEvents() {
        const events = pageData.events || [];
        const container = document.getElementById('eventsContent');
        if (events.length <= 1) {
            container.innerHTML = '<p class="no-events">לא נמצאו אירועים נוספים.</p>';
            return;
        }

        // Show events excluding the headline one, most recent first
        const shown = events.slice(0, -1).reverse().slice(0, 10);
        container.innerHTML = shown.map(ev => `
            <article class="news-item">
                <h4>${ev.year} - ${ev.description}</h4>
                <p class="event-meta">${yearsAgo(ev.year)}${ev.wikiUrl ? ` | <a href="${ev.wikiUrl}" target="_blank" class="item-link">קרא עוד</a>` : ''}</p>
            </article>
        `).join('');
    }

    // Births
    function renderBirths() {
        const births = pageData.births || [];
        const container = document.getElementById('birthsContent');
        if (births.length === 0) {
            container.innerHTML = '<p class="no-events">לא נמצאו נתונים.</p>';
            return;
        }

        // Show most recent births first
        const shown = births.slice().reverse().slice(0, 12);
        container.innerHTML = '<div class="birthdays">' +
            shown.map(b => {
                const age = currentDate.getFullYear() - b.year;
                return `<div class="birthday-item">
                    ${b.wikiUrl ? `<a href="${b.wikiUrl}" target="_blank">` : ''}
                    <strong>${b.description}</strong>
                    ${b.wikiUrl ? '</a>' : ''}
                    (${b.year}) ${age > 0 ? `- בן/בת ${age}` : ''}
                </div>`;
            }).join('') +
            '</div>';
    }

    // Deaths
    function renderDeaths() {
        const deaths = pageData.deaths || [];
        const container = document.getElementById('deathsContent');
        if (deaths.length === 0) {
            container.innerHTML = '<p class="no-events">לא נמצאו נתונים.</p>';
            return;
        }

        const shown = deaths.slice().reverse().slice(0, 10);
        container.innerHTML = '<div class="birthdays">' +
            shown.map(d => `<div class="birthday-item">
                ${d.wikiUrl ? `<a href="${d.wikiUrl}" target="_blank">` : ''}
                <strong>${d.description}</strong>
                ${d.wikiUrl ? '</a>' : ''}
                (${d.year})
            </div>`).join('') +
            '</div>';
    }

    // Historical tweets - next to articles
    function renderTweets() {
        const events = pageData.events || [];
        const container = document.getElementById('tweetsContent');
        if (events.length < 3) {
            document.getElementById('tweetsSection').style.display = 'none';
            return;
        }
        document.getElementById('tweetsSection').style.display = '';

        // Pick 3 spread-out events for variety
        const picks = [
            events[Math.floor(events.length * 0.25)],
            events[Math.floor(events.length * 0.5)],
            events[Math.floor(events.length * 0.75)]
        ].filter(Boolean);

        container.innerHTML = picks.map(ev => {
            const name = ev.description.split(' ').slice(0, 3).join(' ');
            const initial = ev.description.charAt(0);
            const fakeHandle = '@' + ev.description.replace(/\s+/g, '').substring(0, 12);
            const fakeLikes = Math.floor(Math.random() * 9000) + 1000;
            const fakeRT = Math.floor(fakeLikes * 0.4);

            return `
                <div class="historical-tweet">
                    <div class="tweet-header">
                        <div class="tweet-avatar-placeholder">${initial}</div>
                        <div class="tweet-author">
                            <strong>${name}</strong>
                            <span>${fakeHandle}</span>
                        </div>
                        <i class="fab fa-twitter tweet-icon"></i>
                    </div>
                    <div class="tweet-content">
                        [${ev.year}] ${ev.description}
                    </div>
                    <div class="tweet-stats">
                        <span>&hearts; ${formatNumber(fakeLikes)}</span>
                        <span>&#128257; ${formatNumber(fakeRT)}</span>
                    </div>
                </div>
            `;
        }).join('');
    }

    // Timeline
    function renderTimeline() {
        const events = pageData.events || [];
        const container = document.getElementById('timelineContent');
        if (events.length === 0) {
            container.innerHTML = '<li>לא נמצאו אירועים.</li>';
            return;
        }

        // Show oldest events (not shown in main content)
        const shown = events.slice(0, Math.min(events.length - 11, 10));
        if (shown.length === 0) {
            container.parentElement.style.display = 'none';
            return;
        }
        container.parentElement.style.display = '';
        container.innerHTML = shown.map(ev =>
            `<li><strong>${ev.year}</strong> - ${ev.description}</li>`
        ).join('');
    }

    function formatNumber(num) {
        return num >= 1000 ? (num / 1000).toFixed(1) + 'K' : String(num);
    }

    // ====== Init ======
    document.addEventListener('DOMContentLoaded', function () {
        updateDateDisplay();
        loadEventsForDate();
    });
    </script>
</body>
</html>
