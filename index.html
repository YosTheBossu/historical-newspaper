<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>היום בהיסטוריה - העיתון היומי</title>
    <link rel="stylesheet" href="style.css">
    <link href="https://fonts.googleapis.com/css2?family=Heebo:wght@300;400;700;900&family=Frank+Ruhl+Libre:wght@400;700&family=David+Libre:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>
    <div class="container">
        <!-- Red top bar -->
        <div class="top-red-bar"></div>

        <!-- Newspaper Masthead -->
        <header class="newspaper-header">
            <div class="masthead">
                <div class="masthead-side masthead-right">
                    <span class="hebrew-date" id="hebrewDate"></span>
                    <span class="edition-info">מהדורה דיגיטלית</span>
                </div>
                <div class="masthead-center">
                    <h1 class="newspaper-title">היום בהיסטוריה</h1>
                </div>
                <div class="masthead-side masthead-left">
                    <span class="masthead-date" id="currentDate">טוען...</span>
                    <span class="edition-info">גיליון יומי | חינם</span>
                </div>
            </div>
            <div class="header-double-line"></div>
            <div class="subtitle-bar">
                <span class="tagline" id="dailyHeadline">העיתון שמחיה את העבר - נתונים חיים ממקורות ישראליים ועולמיים</span>
                <span>ויקיפדיה | YNET | וואלה | ישראל היום | מעריב | כלכליסט</span>
            </div>

            <div class="controls">
                <button onclick="changeDate(-1)" class="control-btn nav-btn" id="btnPrev">
                    <i class="fas fa-chevron-right"></i> אתמול
                    <i class="fas fa-lock lock-icon"></i>
                </button>
                <button onclick="goToToday()" class="control-btn today-btn">
                    <i class="fas fa-calendar-day"></i> היום
                </button>
                <button onclick="changeDate(1)" class="control-btn nav-btn" id="btnNext">
                    מחר <i class="fas fa-chevron-left"></i>
                    <i class="fas fa-lock lock-icon"></i>
                </button>
            </div>
        </header>

        <!-- Breaking news ticker -->
        <div id="breakingTicker" class="breaking-ticker" style="display:none;">
            <span class="breaking-label">מבזק</span>
            <span class="breaking-text" id="breakingText"></span>
        </div>

        <!-- Stats bar -->
        <div id="statsBar" class="stats-bar" style="display:none;"></div>

        <!-- Loading -->
        <div id="loading" class="loading-indicator">
            <div class="spinner"></div>
            <p>טוען אירועים היסטוריים...</p>
            <p class="loading-sub">מביא נתונים ממקורות ישראליים, ויקיפדיה ועוד</p>
        </div>

        <!-- Error -->
        <div id="errorMsg" class="error-message" style="display:none;">
            <i class="fas fa-exclamation-triangle"></i>
            <p>לא הצלחנו לטעון נתונים. נסה לרענן את הדף.</p>
            <button onclick="loadEventsForDate()" class="control-btn">נסה שוב</button>
        </div>

        <!-- Dynamic Content -->
        <div id="content" style="display: none;">
            <div class="content-area">

                <!-- Main headline -->
                <section id="mainHeadline" class="main-headline"></section>

                <!-- Category filter tabs -->
                <div class="category-tabs" id="categoryTabs">
                    <button class="cat-tab active" data-cat="all"><i class="fas fa-globe"></i> הכל</button>
                    <button class="cat-tab" data-cat="israel"><i class="fas fa-star-of-david"></i> ישראל</button>
                    <button class="cat-tab" data-cat="politics"><i class="fas fa-landmark"></i> פוליטיקה</button>
                    <button class="cat-tab" data-cat="military"><i class="fas fa-shield-alt"></i> ביטחון</button>
                    <button class="cat-tab" data-cat="sports"><i class="fas fa-futbol"></i> ספורט</button>
                    <button class="cat-tab" data-cat="culture"><i class="fas fa-palette"></i> תרבות</button>
                    <button class="cat-tab" data-cat="science"><i class="fas fa-flask"></i> מדע</button>
                </div>

                <!-- Today's news from Israel -->
                <section id="newsSection" class="news-section news-section-highlight" style="display:none;">
                    <h3><i class="fas fa-newspaper"></i> חדשות היום מישראל</h3>
                    <div id="newsContent"></div>
                </section>

                <!-- Historical events - two columns -->
                <section class="news-section">
                    <h3><i class="fas fa-landmark"></i> אירועים היסטוריים</h3>
                    <div id="eventsContent"></div>
                </section>

                <!-- Historical social posts -->
                <section id="socialSection" class="news-section" style="display:none;">
                    <h3><i class="fab fa-x-twitter"></i> ציוצים היסטוריים</h3>
                    <div id="socialContent"></div>
                </section>

                <!-- Holidays -->
                <section id="holidaysSection" class="news-section" style="display:none;">
                    <h3><i class="fas fa-star"></i> חגים ואירועים מיוחדים</h3>
                    <div id="holidaysContent"></div>
                </section>

                <!-- Columns - births and deaths -->
                <div class="columns">
                    <div class="column">
                        <section class="news-section">
                            <h3><i class="fas fa-birthday-cake"></i> נולדו היום</h3>
                            <div id="birthsContent"></div>
                        </section>
                    </div>
                    <div class="column">
                        <section class="news-section">
                            <h3><i class="fas fa-star-of-life"></i> נפטרו היום</h3>
                            <div id="deathsContent"></div>
                        </section>
                    </div>
                </div>

                <!-- Ancient events -->
                <section id="ancientSection" class="news-section ancient-section" style="display:none;">
                    <h3><i class="fas fa-scroll"></i> היום בהיסטוריה העתיקה</h3>
                    <div id="ancientContent"></div>
                </section>

                <!-- Timeline -->
                <section class="news-section" id="timelineSection">
                    <h3><i class="fas fa-calendar-alt"></i> עוד היום בהיסטוריה</h3>
                    <ul id="timelineContent" class="timeline"></ul>
                </section>

                <!-- Premium banner -->
                <div id="premiumBanner" class="premium-banner">
                    <div class="premium-inner">
                        <i class="fas fa-crown premium-icon"></i>
                        <div class="premium-text">
                            <h3>רוצה לראות תאריכים אחרים?</h3>
                            <p>עם מנוי פרימיום תוכל לגלול אחורה ולראות כל יום בהיסטוריה. גם תקבל גישה לארכיון מלא, תמונות היסטוריות, ותכנים בלעדיים.</p>
                            <div class="premium-features">
                                <span><i class="fas fa-check"></i> ניווט בין תאריכים</span>
                                <span><i class="fas fa-check"></i> ארכיון מלא</span>
                                <span><i class="fas fa-check"></i> ללא פרסומות</span>
                            </div>
                        </div>
                        <button class="premium-btn" onclick="handleSubscribe()">
                            <i class="fas fa-unlock"></i> הירשם עכשיו
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Footer -->
        <footer class="newspaper-footer">
            <div class="footer-content">
                <div class="footer-section">
                    <h4>אודות העיתון</h4>
                    <p>"היום בהיסטוריה" מביא לכם בכל יום את האירועים החשובים שהתרחשו בתאריך הזה לאורך השנים.</p>
                </div>
                <div class="footer-section">
                    <h4>מקור הנתונים</h4>
                    <p>הנתונים מגיעים מויקיפדיה, YNET, וואלה, ישראל היום, מעריב, כלכליסט ומקורות נוספים.</p>
                </div>
                <div class="footer-section">
                    <h4>צרו קשר</h4>
                    <p>הצעות, תיקונים, רעיונות?<br>history@newspaper.co.il</p>
                </div>
            </div>
            <div class="copyright">
                &copy; 2026 "היום בהיסטוריה" - כל הזכויות שמורות
            </div>
        </footer>
    </div>

    <script>
    // ====== Configuration ======
    const API = {
        HE: 'https://he.wikipedia.org/api/rest_v1/feed/onthisday/all',
        EN: 'https://en.wikipedia.org/api/rest_v1/feed/onthisday/all',
        HEBCAL: 'https://www.hebcal.com/converter'
    };

    const LIMITS = { EVENTS: 15, BIRTHS: 15, DEATHS: 12 };

    const CATEGORY_LABELS = {
        israel: 'ישראל',
        politics: 'פוליטיקה',
        military: 'ביטחון',
        sports: 'ספורט',
        culture: 'תרבות',
        science: 'מדע',
        general: 'כללי'
    };

    const CATEGORY_COLORS = {
        israel:   { bg: '#dbeafe', text: '#1e3a5f' },
        politics: { bg: '#fce4ec', text: '#7b1a2c' },
        military: { bg: '#e8f5e9', text: '#1b5e20' },
        sports:   { bg: '#fff3e0', text: '#bf360c' },
        culture:  { bg: '#f3e5f5', text: '#4a148c' },
        science:  { bg: '#e1f5fe', text: '#01579b' },
        general:  { bg: '#f5f5f5', text: '#424242' }
    };

    // ====== State ======
    let currentDate = new Date();
    let allData = null;
    let activeCategory = 'all';
    let isSubscriber = localStorage.getItem('newspaper_sub') === 'true';

    if (new URLSearchParams(window.location.search).get('subscribe') === 'true') {
        localStorage.setItem('newspaper_sub', 'true');
        isSubscriber = true;
    }

    // ====== Helpers ======
    function pad2(n) { return String(n).padStart(2, '0'); }

    function escapeHtml(text) {
        if (!text) return '';
        const el = document.createElement('span');
        el.textContent = text;
        return el.innerHTML;
    }

    function yearsAgo(year) {
        if (!year) return '';
        const diff = currentDate.getFullYear() - year;
        if (diff <= 0) return '';
        if (diff === 1) return 'לפני שנה';
        return `לפני ${diff} שנים`;
    }

    function formatNumber(num) {
        return num >= 1000 ? (num / 1000).toFixed(1) + 'K' : String(num);
    }

    function getCategoryBadge(category) {
        if (!category || category === 'general') return '';
        const label = CATEGORY_LABELS[category] || category;
        const colors = CATEGORY_COLORS[category] || CATEGORY_COLORS.general;
        return `<span class="category-badge" style="background-color:${colors.bg};color:${colors.text}">${escapeHtml(label)}</span>`;
    }

    // ====== Data Fetching ======
    async function loadFromCachedJson() {
        const todayStr = currentDate.toISOString().slice(0, 10);
        const resp = await fetch('today.json?_=' + Date.now());
        if (!resp.ok) throw new Error('No cached data');
        const data = await resp.json();
        if (data.date !== todayStr) throw new Error('Cached data is stale');
        if (!data.sourceStats) {
            data.sourceStats = data.stats || { he: 0, en: 0 };
        }
        console.log('Loaded from today.json (server-enriched data)');
        return data;
    }

    async function fetchWikiAPI(baseUrl, month, day) {
        const url = `${baseUrl}/${pad2(month)}/${pad2(day)}`;
        const resp = await fetch(url, {
            headers: { 'Api-User-Agent': 'HistoricalNewspaper/1.0 (educational project)' }
        });
        if (!resp.ok) throw new Error(`HTTP ${resp.status}`);
        return resp.json();
    }

    function processEntry(entry, lang) {
        const page = (entry.pages || [])[0] || {};
        return {
            year: entry.year || 0,
            text: entry.text || '',
            lang: lang,
            extract: page.extract || null,
            thumbnail: (page.thumbnail && page.thumbnail.source) || null,
            pageTitle: page.title || '',
            category: 'general'
        };
    }

    // Client-side category classifier (for fallback mode without server data)
    const CLIENT_KEYWORDS = {
        israel: ['ישראל', 'ירושלים', 'תל אביב', 'חיפה', 'כנסת', 'צה"ל', 'צהל', 'ציונ',
            'israel', 'israeli', 'jerusalem', 'tel aviv', 'knesset', 'idf', 'kibbutz', 'mossad'],
        politics: ['נשיא', 'ממשלה', 'בחירות', 'מלך', 'קיסר', 'president', 'king', 'queen', 'election', 'parliament', 'empire', 'kingdom', 'republic', 'treaty'],
        military: ['מלחמ', 'קרב', 'צבא', 'טרור', 'war', 'battle', 'army', 'attack', 'invasion', 'bombing', 'siege', 'military'],
        sports: ['אולימפ', 'כדורגל', 'אליפות', 'olympic', 'football', 'soccer', 'championship', 'world cup', 'medal', 'tournament'],
        culture: ['סרט', 'מוסיקה', 'סופר', 'אוסקר', 'נובל', 'film', 'movie', 'music', 'oscar', 'nobel', 'author', 'singer', 'opera'],
        science: ['מדע', 'חלל', 'המצא', 'science', 'space', 'nasa', 'computer', 'invent', 'discover', 'satellite', 'rocket']
    };

    function classifyClient(entry) {
        const text = ((entry.text || '') + ' ' + (entry.extract || '')).toLowerCase();
        for (const [cat, keywords] of Object.entries(CLIENT_KEYWORDS)) {
            for (const kw of keywords) {
                if (text.includes(kw.toLowerCase())) return cat;
            }
        }
        return 'general';
    }

    async function loadFromLiveAPIs() {
        const m = currentDate.getMonth() + 1;
        const d = currentDate.getDate();
        const y = currentDate.getFullYear();

        const [heRes, enRes, hebRes] = await Promise.allSettled([
            fetchWikiAPI(API.HE, m, d),
            fetchWikiAPI(API.EN, m, d),
            fetch(`${API.HEBCAL}?cfg=json&gy=${y}&gm=${m}&gd=${d}&g2h=1`).then(r => r.json())
        ]);

        const he = heRes.status === 'fulfilled' ? heRes.value : null;
        const en = enRes.status === 'fulfilled' ? enRes.value : null;
        const heb = hebRes.status === 'fulfilled' ? hebRes.value : null;

        if (!he && !en) throw new Error('No data sources available');

        const data = {
            events: [], births: [], deaths: [],
            selected: [], holidays: [], socialPosts: [], news: [],
            hebrewDate: (heb && heb.hebrew) || '',
            sourceStats: { he: 0, en: 0 }
        };

        function addUnique(target, source, lang) {
            const existingYears = new Set(target.map(e => e.year));
            let added = 0;
            for (const e of source) {
                if (!existingYears.has(e.year)) {
                    target.push(processEntry(e, lang));
                    existingYears.add(e.year);
                    added++;
                }
            }
            return added;
        }

        if (he) {
            for (const cat of ['events', 'births', 'deaths', 'selected', 'holidays']) {
                for (const item of (he[cat] || [])) {
                    data[cat].push(processEntry(item, 'he'));
                    data.sourceStats.he++;
                }
            }
        }

        if (en) {
            for (const cat of ['events', 'births', 'deaths', 'selected', 'holidays']) {
                data.sourceStats.en += addUnique(data[cat], en[cat] || [], 'en');
            }
        }

        // Classify and sort client-side
        for (const cat of ['events', 'births', 'deaths', 'selected']) {
            for (const entry of data[cat]) {
                entry.category = classifyClient(entry);
            }
        }

        data.events.sort((a, b) => {
            if (a.category === 'israel' && b.category !== 'israel') return -1;
            if (a.category !== 'israel' && b.category === 'israel') return 1;
            return b.year - a.year;
        });
        data.births.sort((a, b) => b.year - a.year);
        data.deaths.sort((a, b) => b.year - a.year);

        console.log('Loaded from live Wikipedia APIs (fallback)');
        return data;
    }

    async function loadData() {
        try {
            return await loadFromCachedJson();
        } catch (e) {
            console.log('Cached data unavailable, trying live APIs...', e.message);
        }
        return await loadFromLiveAPIs();
    }

    // ====== Date Display ======
    function updateDateDisplay() {
        const opts = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
        document.getElementById('currentDate').textContent =
            currentDate.toLocaleDateString('he-IL', opts);
    }

    // ====== Date Navigation ======
    function changeDate(days) {
        if (!isSubscriber) {
            showPremiumPrompt();
            return;
        }
        currentDate = new Date(currentDate.getTime() + days * 86400000);
        updateDateDisplay();
        loadEventsForDate();
    }

    function goToToday() {
        currentDate = new Date();
        updateDateDisplay();
        loadEventsForDate();
    }

    function showPremiumPrompt() {
        const banner = document.getElementById('premiumBanner');
        if (banner) {
            banner.classList.add('highlight');
            banner.scrollIntoView({ behavior: 'smooth', block: 'center' });
            setTimeout(() => banner.classList.remove('highlight'), 2000);
        }
    }

    function handleSubscribe() {
        alert('מערכת המנויים בבנייה. בקרוב תוכל להירשם!');
    }

    // ====== Category Tabs ======
    function initCategoryTabs() {
        document.querySelectorAll('.cat-tab').forEach(tab => {
            tab.addEventListener('click', () => {
                document.querySelectorAll('.cat-tab').forEach(t => t.classList.remove('active'));
                tab.classList.add('active');
                activeCategory = tab.dataset.cat;
                renderEvents();
                renderTimeline();
            });
        });
    }

    // ====== Main Loader ======
    async function loadEventsForDate() {
        document.getElementById('loading').style.display = 'block';
        document.getElementById('content').style.display = 'none';
        document.getElementById('errorMsg').style.display = 'none';
        document.getElementById('statsBar').style.display = 'none';
        document.getElementById('breakingTicker').style.display = 'none';

        try {
            allData = await loadData();

            if (allData.hebrewDate) {
                document.getElementById('hebrewDate').textContent = allData.hebrewDate;
            }

            document.getElementById('loading').style.display = 'none';
            document.getElementById('content').style.display = 'block';
            document.getElementById('statsBar').style.display = '';
            renderAll();
        } catch (err) {
            console.error('Fetch error:', err);
            document.getElementById('loading').style.display = 'none';
            document.getElementById('errorMsg').style.display = 'flex';
        }
    }

    // ====== Social Post Builder ======
    function buildSocialPostHtml(post) {
        const initial = (post.author || '?').charAt(0);
        const platform = post.platform || 'twitter';

        const platforms = {
            twitter: {
                cls: 'social-twitter',
                icon: 'fab fa-x-twitter',
                iconColor: '#000',
                avatarBg: '#000',
                name: 'X',
                verifiedColor: '#1d9bf0',
                stats: [
                    { icon: 'far fa-comment', val: post.replies },
                    { icon: 'fas fa-retweet', val: post.retweets },
                    { icon: 'far fa-heart', val: post.likes }
                ]
            },
            facebook: {
                cls: 'social-facebook',
                icon: 'fab fa-facebook',
                iconColor: '#1877f2',
                avatarBg: '#1877f2',
                name: 'Facebook',
                verifiedColor: '#1877f2',
                stats: [
                    { icon: 'fas fa-thumbs-up', val: post.likes },
                    { icon: 'far fa-comment-alt', val: post.replies },
                    { icon: 'fas fa-share', val: post.retweets }
                ]
            },
            instagram: {
                cls: 'social-instagram',
                icon: 'fab fa-instagram',
                iconColor: '#e4405f',
                avatarBg: '#c13584',
                name: 'Instagram',
                verifiedColor: '#3897f0',
                stats: [
                    { icon: 'far fa-heart', val: post.likes },
                    { icon: 'far fa-comment', val: post.replies },
                    { icon: 'far fa-paper-plane', val: post.retweets }
                ]
            }
        };

        const p = platforms[platform] || platforms.twitter;

        return `
            <div class="social-post ${p.cls}">
                <div class="social-post-header">
                    <div class="social-avatar" style="background-color:${p.avatarBg}">${escapeHtml(initial)}</div>
                    <div class="social-author-info">
                        <strong>${escapeHtml(post.author || '')} <i class="fas fa-check-circle" style="color:${p.verifiedColor};font-size:11px"></i></strong>
                        <span>${escapeHtml(post.handle || '')}</span>
                    </div>
                    <div class="social-platform-badge">
                        <i class="${p.icon}" style="color:${p.iconColor};font-size:18px"></i>
                    </div>
                </div>
                <div class="social-post-body">${escapeHtml(post.content || '')}</div>
                <div class="social-post-actions">
                    ${p.stats.map(s => `<span><i class="${s.icon}"></i> ${formatNumber(s.val || 0)}</span>`).join('')}
                </div>
            </div>
        `;
    }

    // ====== Render ======
    function renderAll() {
        if (!allData) return;
        renderStatsBar();
        renderBreakingTicker();
        renderMainHeadline();
        renderNews();
        renderEvents();
        renderSocialPosts();
        renderBirths();
        renderDeaths();
        renderHolidays();
        renderAncientEvents();
        renderTimeline();
    }

    function renderStatsBar() {
        const bar = document.getElementById('statsBar');
        const israelCount = (allData.events || []).filter(e => e.category === 'israel').length;
        bar.innerHTML = `
            <span><i class="fas fa-star-of-david"></i> ${israelCount} ישראל</span>
            <span><i class="fas fa-landmark"></i> ${allData.events.length} אירועים</span>
            <span><i class="fas fa-birthday-cake"></i> ${allData.births.length} לידות</span>
            <span><i class="fas fa-star-of-life"></i> ${allData.deaths.length} פטירות</span>
            ${(allData.socialPosts || []).length > 0 ? `<span><i class="fab fa-x-twitter"></i> ${allData.socialPosts.length} ציוצים</span>` : ''}
            ${(allData.news || []).length > 0 ? `<span><i class="fas fa-newspaper"></i> ${allData.news.length} חדשות</span>` : ''}
        `;
    }

    function renderBreakingTicker() {
        const ticker = document.getElementById('breakingTicker');
        const textEl = document.getElementById('breakingText');

        // Use the first Israeli event or headline for the ticker
        let tickerText = '';
        if (allData.headline) {
            tickerText = `${allData.headline.year}: ${allData.headline.text}`;
        } else {
            const israelEv = (allData.events || []).find(e => e.category === 'israel');
            if (israelEv) {
                tickerText = `${israelEv.year}: ${israelEv.text}`;
            }
        }

        if (tickerText) {
            textEl.textContent = tickerText;
            ticker.style.display = 'flex';
        }
    }

    function renderMainHeadline() {
        const el = document.getElementById('mainHeadline');

        let ev = null;

        if (allData.headline) {
            ev = allData.headline;
        }

        if (!ev) {
            const israelHebrew = [...(allData.selected || []), ...(allData.events || [])]
                .filter(e => e.category === 'israel' && e.lang === 'he' && !e.isAncient);
            if (israelHebrew.length > 0) {
                ev = israelHebrew.find(e => e.thumbnail) || israelHebrew[0];
            }
        }

        if (!ev) {
            const israelAny = [...(allData.selected || []), ...(allData.events || [])]
                .filter(e => e.category === 'israel' && !e.isAncient);
            if (israelAny.length > 0) {
                ev = israelAny.find(e => e.thumbnail) || israelAny[0];
            }
        }

        if (!ev) {
            const pool = allData.selected.length > 0 ? allData.selected : allData.events;
            const nonAncient = pool.filter(e => !e.isAncient);
            ev = (nonAncient.find(e => e.thumbnail) || nonAncient[0] || pool[0]);
        }

        if (!ev) {
            el.innerHTML = '<h2>לא נמצאו אירועים בולטים לתאריך זה</h2>';
            return;
        }

        const ago = yearsAgo(ev.year);
        const catBadge = getCategoryBadge(ev.category);
        const isIsrael = ev.category === 'israel';

        const imgHtml = ev.thumbnail
            ? `<div class="headline-image-wrap">
                 <img src="${escapeHtml(ev.thumbnail)}" alt="" class="headline-image"
                      onerror="this.parentElement.style.display='none'">
               </div>`
            : '';

        el.innerHTML = `
            <div class="headline-category">${isIsrael ? '<i class="fas fa-star-of-david"></i> ' : ''}אירוע מרכזי ${catBadge}</div>
            <div class="headline-layout">
                <div class="headline-text">
                    <h2>${escapeHtml(String(ev.year))} - ${escapeHtml(ev.text)}</h2>
                    <div class="headline-meta">
                        <span class="byline"><i class="fas fa-book"></i> ${ev.lang === 'he' ? 'ויקיפדיה העברית' : 'ויקיפדיה'}</span>
                        <span class="time">${ago || ''}</span>
                    </div>
                    ${ev.extract ? `<p class="headline-extract">${escapeHtml(ev.extract)}</p>` : ''}
                </div>
                ${imgHtml}
            </div>
        `;

        const sub = ev.text.length > 80 ? ev.text.substring(0, 80) + '...' : ev.text;
        document.getElementById('dailyHeadline').textContent = `${ago} | ${sub}`;
    }

    function renderEvents() {
        const container = document.getElementById('eventsContent');
        let events = allData.events;

        if (activeCategory !== 'all') {
            events = events.filter(e => e.category === activeCategory);
        }
        events = events.slice(0, LIMITS.EVENTS);

        if (events.length === 0) {
            container.innerHTML = `<p class="no-events">לא נמצאו אירועים בקטגוריה זו.</p>`;
            return;
        }

        container.innerHTML = '<div class="events-columns">' + events.map(ev => {
            const ago = yearsAgo(ev.year);
            const catBadge = getCategoryBadge(ev.category);
            const thumb = ev.thumbnail
                ? `<img src="${escapeHtml(ev.thumbnail)}" class="event-thumb" alt="" onerror="this.style.display='none'">`
                : '';

            return `
                <article class="news-item">
                    <div class="event-year-badge">${ev.year}</div>
                    <div class="event-body">
                        ${thumb}
                        <div class="event-text">
                            <h4>${escapeHtml(ev.text)} ${catBadge}</h4>
                            ${ev.extract ? `<p class="event-extract">${escapeHtml(ev.extract.length > 200 ? ev.extract.substring(0, 120) + '...' : ev.extract)}</p>` : ''}
                            <p class="event-meta">${ago}</p>
                        </div>
                    </div>
                </article>
            `;
        }).join('') + '</div>';
    }

    function renderSocialPosts() {
        const section = document.getElementById('socialSection');
        const container = document.getElementById('socialContent');
        const posts = allData.socialPosts || [];

        if (posts.length === 0) {
            section.style.display = 'none';
            return;
        }

        section.style.display = '';
        container.innerHTML = '<div class="social-posts-grid">' +
            posts.map(post => buildSocialPostHtml(post)).join('') +
            '</div>';
    }

    function renderBirths() {
        const container = document.getElementById('birthsContent');
        const births = allData.births.slice(0, LIMITS.BIRTHS);
        if (births.length === 0) {
            container.innerHTML = '<p class="no-events">לא נמצאו נתונים.</p>';
            return;
        }

        container.innerHTML = '<div class="birthdays">' +
            births.map(b => {
                const age = currentDate.getFullYear() - b.year;
                const thumb = b.thumbnail
                    ? `<img src="${escapeHtml(b.thumbnail)}" class="person-thumb" alt="" onerror="this.outerHTML='<div class=\\'person-thumb-placeholder\\'><i class=\\'fas fa-user\\'></i></div>'">`
                    : '<div class="person-thumb-placeholder"><i class="fas fa-user"></i></div>';
                const catBadge = getCategoryBadge(b.category);
                return `<div class="birthday-item person-card">
                    ${thumb}
                    <div class="person-info">
                        <strong>${escapeHtml(b.text)}</strong> ${catBadge}
                        <span class="person-year">(${b.year})${age > 0 ? ` - בן/בת ${age}` : ''}</span>
                    </div>
                </div>`;
            }).join('') +
            '</div>';
    }

    function renderDeaths() {
        const container = document.getElementById('deathsContent');
        const deaths = allData.deaths.slice(0, LIMITS.DEATHS);
        if (deaths.length === 0) {
            container.innerHTML = '<p class="no-events">לא נמצאו נתונים.</p>';
            return;
        }

        container.innerHTML = '<div class="birthdays deaths-list">' +
            deaths.map(d => {
                const thumb = d.thumbnail
                    ? `<img src="${escapeHtml(d.thumbnail)}" class="person-thumb" alt="" onerror="this.outerHTML='<div class=\\'person-thumb-placeholder\\'><i class=\\'fas fa-user\\'></i></div>'">`
                    : '<div class="person-thumb-placeholder"><i class="fas fa-user"></i></div>';
                const catBadge = getCategoryBadge(d.category);
                return `<div class="birthday-item person-card">
                    ${thumb}
                    <div class="person-info">
                        <strong>${escapeHtml(d.text)}</strong> ${catBadge}
                        <span class="person-year">(${d.year})</span>
                    </div>
                </div>`;
            }).join('') +
            '</div>';
    }

    function renderHolidays() {
        const section = document.getElementById('holidaysSection');
        const container = document.getElementById('holidaysContent');
        if (!allData.holidays || allData.holidays.length === 0) {
            section.style.display = 'none';
            return;
        }
        section.style.display = '';
        container.innerHTML = '<div class="holidays-list">' +
            allData.holidays.map(h => {
                return `<div class="holiday-item">
                    <i class="fas fa-star holiday-star"></i>
                    <span>${escapeHtml(h.text)}</span>
                </div>`;
            }).join('') +
            '</div>';
    }

    function renderNews() {
        const section = document.getElementById('newsSection');
        const container = document.getElementById('newsContent');
        const news = allData.news || [];
        if (news.length === 0) {
            section.style.display = 'none';
            return;
        }
        section.style.display = '';

        const sourceIcons = {
            'ynet': 'fas fa-bolt',
            'וואלה': 'fas fa-fire',
            'Google News': 'fab fa-google',
            'מעריב': 'fas fa-newspaper',
            'ישראל היום': 'fas fa-sun',
            'כלכליסט': 'fas fa-chart-line',
            'default': 'fas fa-newspaper'
        };

        container.innerHTML = '<div class="news-list">' +
            news.slice(0, 10).map(n => {
                const srcIcon = sourceIcons[n.source] || sourceIcons['default'];
                const hasImage = n.image && n.image.startsWith('http');

                if (hasImage) {
                    return `
                    <div class="news-card">
                        <div class="news-card-with-image">
                            <img src="${escapeHtml(n.image)}" class="news-card-image" alt="" onerror="this.style.display='none'">
                            <div class="news-card-text">
                                <a href="${escapeHtml(n.url)}" target="_blank" rel="noopener">
                                    ${escapeHtml(n.title)}
                                </a>
                                ${n.summary ? `<p class="news-summary">${escapeHtml(n.summary.substring(0, 100))}${n.summary.length > 100 ? '...' : ''}</p>` : ''}
                                <span class="news-source"><i class="${srcIcon}"></i> ${escapeHtml(n.source || '')}</span>
                            </div>
                        </div>
                    </div>`;
                }

                return `
                <div class="news-card">
                    <a href="${escapeHtml(n.url)}" target="_blank" rel="noopener">
                        ${escapeHtml(n.title)}
                    </a>
                    ${n.summary ? `<p class="news-summary">${escapeHtml(n.summary.substring(0, 120))}${n.summary.length > 120 ? '...' : ''}</p>` : ''}
                    <span class="news-source"><i class="${srcIcon}"></i> ${escapeHtml(n.source || '')}</span>
                </div>`;
            }).join('') +
            '</div>';
    }

    function renderAncientEvents() {
        const section = document.getElementById('ancientSection');
        const container = document.getElementById('ancientContent');
        const ancientEvents = (allData.ancientEvents || []).concat(
            (allData.events || []).filter(e => e.isAncient)
        );

        const seen = new Set();
        const unique = ancientEvents.filter(e => {
            const key = e.text;
            if (seen.has(key)) return false;
            seen.add(key);
            return true;
        });

        if (unique.length === 0) {
            section.style.display = 'none';
            return;
        }

        section.style.display = '';
        unique.sort((a, b) => a.year - b.year);

        container.innerHTML = '<div class="ancient-events-list">' +
            unique.map(ev => {
                const yearDisplay = ev.year < 0
                    ? `${Math.abs(ev.year)} לפנה"ס`
                    : String(ev.year);
                const catBadge = getCategoryBadge(ev.category);
                return `
                    <div class="ancient-event-item">
                        <div class="ancient-year">${escapeHtml(yearDisplay)}</div>
                        <div class="ancient-text">
                            <span>${escapeHtml(ev.text)}</span> ${catBadge}
                        </div>
                    </div>
                `;
            }).join('') +
            '</div>';
    }

    function renderTimeline() {
        const section = document.getElementById('timelineSection');
        const container = document.getElementById('timelineContent');
        let remaining = allData.events.slice(LIMITS.EVENTS);

        if (activeCategory !== 'all') {
            remaining = allData.events.filter(e => e.category === activeCategory).slice(LIMITS.EVENTS);
        }

        if (remaining.length === 0) {
            section.style.display = 'none';
            return;
        }
        section.style.display = '';

        container.innerHTML = remaining.slice(0, 20).reverse().map(ev => {
            const catBadge = getCategoryBadge(ev.category);
            return `<li><strong>${ev.year}</strong> - ${escapeHtml(ev.text)} ${catBadge}</li>`;
        }).join('');
    }

    // ====== Auto-refresh: poll for updated data from background collector ======
    let refreshAttempts = 0;
    const MAX_REFRESH = 12;

    function startAutoRefresh() {
        if (refreshAttempts >= MAX_REFRESH) return;

        setTimeout(async () => {
            refreshAttempts++;
            try {
                const resp = await fetch('today.json?_=' + Date.now());
                if (!resp.ok) return startAutoRefresh();
                const data = await resp.json();

                const hasTranslations = data.stats && data.stats.translated > 0;
                const hasSocialPosts = data.socialPosts && data.socialPosts.length > 0;
                const hasAncient = data.ancientEvents && data.ancientEvents.length > 0;

                const currentHas = allData && allData.socialPosts && allData.socialPosts.length > 0;

                if ((hasTranslations || hasSocialPosts || hasAncient) && !currentHas) {
                    console.log('Auto-refresh: updated data detected, re-rendering');
                    if (!data.sourceStats) data.sourceStats = data.stats || { he: 0, en: 0 };
                    allData = data;
                    renderAll();
                    return;
                }
            } catch (e) {
                console.log('Auto-refresh check failed:', e.message);
            }

            if (refreshAttempts < MAX_REFRESH) startAutoRefresh();
        }, 30000);
    }

    // ====== Init ======
    document.addEventListener('DOMContentLoaded', function () {
        if (!isSubscriber) {
            document.querySelectorAll('.nav-btn').forEach(btn => {
                btn.classList.add('locked');
            });
        } else {
            document.querySelectorAll('.lock-icon').forEach(icon => {
                icon.style.display = 'none';
            });
            const banner = document.getElementById('premiumBanner');
            if (banner) banner.style.display = 'none';
        }

        initCategoryTabs();
        currentDate = new Date();
        updateDateDisplay();
        loadEventsForDate().then(() => {
            if (allData && (!allData.socialPosts || allData.socialPosts.length === 0)) {
                console.log('Starting auto-refresh to wait for background collector...');
                startAutoRefresh();
            }
        });
    });
    </script>
</body>
</html>
