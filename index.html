<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>דברי הימים — עיתון היסטורי יומי</title>
    <link rel="stylesheet" href="style.css">
    <link href="https://fonts.googleapis.com/css2?family=David+Libre:wght@400;500;700&family=Frank+Ruhl+Libre:wght@300;400;500;700;900&family=Heebo:wght@300;400;500;700;800;900&family=Noto+Serif+Hebrew:wght@400;700&display=swap" rel="stylesheet">
</head>
<body>

<div class="newspaper-page">

    <!-- Edition Bar -->
    <div class="edition-bar">
        <span id="volume-text">כרך פ״ו</span>
        <span class="ornament">◆</span>
        <span id="edition-text">מהדורת בוקר</span>
        <span class="ornament">◆</span>
        <span>גיליון מיוחד — היום בהיסטוריה</span>
    </div>

    <!-- Masthead Double Rule Top -->
    <div class="masthead-double-rule"></div>

    <!-- Masthead -->
    <header class="masthead">
        <div class="masthead-inner">
            <div class="masthead-date masthead-date-right" id="hebrew-date-wrap">
                <span class="masthead-date-label">לוח עברי</span>
                <span id="hebrew-date"></span>
            </div>
            <div class="masthead-center">
                <div class="masthead-ornament">❦ ✦ ❦</div>
                <h1 class="newspaper-title">דברי הימים</h1>
                <div class="newspaper-subtitle">אירועים שעיצבו את ישראל והעולם — היום בהיסטוריה</div>
                <div class="masthead-ornament">❦ ✦ ❦</div>
            </div>
            <div class="masthead-date masthead-date-left" id="gregorian-date-wrap">
                <span class="masthead-date-label">לוח גרגוריאני</span>
                <span id="gregorian-date"></span>
            </div>
        </div>
    </header>

    <!-- Masthead Double Rule Bottom -->
    <div class="masthead-double-rule"></div>
    <div class="masthead-rule"></div>

    <!-- Ticker — news telegram -->
    <div class="ticker-bar">
        <span class="ticker-label">מברק ◆ פלאשבק</span>
        <div class="ticker-track">
            <div class="ticker-scroll" id="ticker-scroll"></div>
        </div>
    </div>

    <!-- Holiday Strip -->
    <div class="holiday-strip" id="holiday-strip" style="display:none">
        <span class="holiday-strip-label">חגים היום בהיסטוריה</span>
        <div id="holiday-tags"></div>
    </div>

    <!-- Main headline -->
    <section class="headline-section" id="headline-section"></section>

    <!-- Secondary headlines -->
    <section class="secondary-headlines" id="secondary-headlines"></section>

    <div class="section-rule"></div>

    <!-- Three-column newspaper body -->
    <main class="newspaper-body" id="newspaper-body">
        <div class="column column-right" id="column-right"></div>
        <div class="column-divider"></div>
        <div class="column column-center" id="column-center"></div>
        <div class="column-divider"></div>
        <div class="column column-left" id="column-left"></div>
    </main>

    <!-- Births & Deaths -->
    <section class="people-section" id="people-section"></section>

    <!-- Footer -->
    <footer class="newspaper-footer">
        <div class="footer-ornament">✦ ✦ ✦</div>
        <div class="footer-inner">
            <span>© דברי הימים — עיתון היסטורי יומי | נתונים מוויקיפדיה</span>
            <span id="stats-bar"></span>
        </div>
    </footer>

</div><!-- /.newspaper-page -->

<!-- Loading overlay -->
<div class="loading-overlay" id="loading-overlay">
    <div class="loading-spinner"></div>
    <p>טוען את גיליון היום...</p>
</div>

<script>
// ====== Section Config ======
var SECTION_NAMES = {
    israel:'ישראל', politics:'מדיני', military:'צבאי ובטחוני',
    science:'מדע וטכנולוגיה', culture:'תרבות ובידור', sports:'ספורט',
    economy:'כלכלה', religion:'דת ומסורת', world:'עולמי', general:'כללי'
};
var SECTION_COLORS = {
    israel:'#1a3a5c', politics:'#5c1a1a', military:'#2a3a2a',
    science:'#1a4a3a', culture:'#4a2a4a', sports:'#5c3a1a',
    economy:'#3a2a1a', religion:'#2a1a4a', world:'#1a2a4a', general:'#3a3a3a'
};

// ====== Data Loading ======
function loadData() {
    return fetch('today.json?t=' + Date.now())
        .then(function(r) { if (!r.ok) throw new Error(); return r.json(); })
        .then(function(d) { if (d && d.events && d.events.length > 0) return d; throw new Error(); })
        .catch(function() {
            return fetch('example-events.json')
                .then(function(r2) { return r2.ok ? r2.json() : null; })
                .catch(function() { return null; });
        });
}

// ====== Helpers ======
function fmtNum(n) { return n >= 1000 ? (n/1000).toFixed(1)+'K' : String(n||0); }
function fmtYear(y) { return y < 0 ? Math.abs(y)+' לפנה\"ס' : String(y); }
function calcYearsAgo(y) { return Math.abs(new Date().getFullYear() - y); }
function esc(s) { if (!s) return ''; var d=document.createElement('div'); d.textContent=String(s); return d.innerHTML; }
function catColor(cat) { return SECTION_COLORS[cat] || '#3a3a3a'; }

// Hebrew numerals for volume number
function toHebrewYear(year) {
    var hebrewNumerals = {
        1:'א', 2:'ב', 3:'ג', 4:'ד', 5:'ה', 6:'ו', 7:'ז', 8:'ח', 9:'ט',
        10:'י', 20:'כ', 30:'ל', 40:'מ', 50:'נ', 60:'ס', 70:'ע', 80:'פ', 90:'צ',
        100:'ק', 200:'ר', 300:'ש', 400:'ת'
    };
    // Simple approximation: use last 2 digits of Hebrew year
    var hy = year + 3760; // approximate Hebrew year
    var tens = Math.floor((hy % 100) / 10) * 10;
    var ones = hy % 10;
    var result = '';
    if (tens > 0 && hebrewNumerals[tens]) result += hebrewNumerals[tens];
    if (ones > 0 && hebrewNumerals[ones]) result += hebrewNumerals[ones];
    if (result.length === 0) result = 'פ״ו';
    if (result.length === 1) result += '׳';
    else result = result.slice(0, -1) + '״' + result.slice(-1);
    return result;
}

// ====== Render Functions ======
function renderDates(data) {
    document.getElementById('hebrew-date').textContent = data.hebrewDate || '';
    if (data.date) {
        var d = new Date(data.date + 'T00:00:00');
        document.getElementById('gregorian-date').textContent =
            d.toLocaleDateString('he-IL',{weekday:'long',year:'numeric',month:'long',day:'numeric'});

        // Volume number from year
        var vol = toHebrewYear(d.getFullYear());
        document.getElementById('volume-text').textContent = 'כרך ' + vol;
    }
    var h = new Date().getHours();
    document.getElementById('edition-text').textContent =
        h < 12 ? 'מהדורת בוקר' : h < 18 ? 'מהדורת צהריים' : 'מהדורת ערב';
}

function renderTicker(data) {
    var el = document.getElementById('ticker-scroll');
    var items = [].concat(data.selected||[], data.events||[]).slice(0, 14);
    var html = items.map(function(e) {
        return '<span class="ticker-item"><b>'+fmtYear(e.year)+'</b> — '+esc(e.text)+'</span>';
    }).join('<span class="ticker-sep">◆</span>');
    el.innerHTML = html + html;
}

function renderHolidays(data) {
    var holidays = data.holidays || [];
    var strip = document.getElementById('holiday-strip');
    var tagsEl = document.getElementById('holiday-tags');
    if (!holidays.length) { strip.style.display = 'none'; return; }
    strip.style.display = 'flex';
    tagsEl.innerHTML = holidays.map(function(h) {
        return '<span class="holiday-tag">'+esc(h.text || h.title)+'</span>';
    }).join('');
}

function renderSocialPost(post) {
    if (!post) return '';
    return '<div class="social-embed">'
        + '<span class="social-imagined-label">✉ מברק מדומה מהעבר</span>'
        + '<div class="social-header">'
        + '<span class="social-author">'+esc(post.author)+'</span>'
        + '<span class="social-handle">'+esc(post.handle)+'</span>'
        + '</div>'
        + '<p class="social-text">'+esc(post.content)+'</p>'
        + '<div class="social-stats">'
        + '<span>תגובות: '+fmtNum(post.replies)+'</span>'
        + '<span>הדים: '+fmtNum(post.retweets)+'</span>'
        + '<span>אהבו: '+fmtNum(post.likes)+'</span>'
        + '</div></div>';
}

function renderHeadline(data) {
    var sec = document.getElementById('headline-section');
    var h = data.headline;
    if (!h) { sec.innerHTML = '<div class="headline-body"><h2 class="main-headline">דף חלק</h2></div>'; return; }
    var catName = SECTION_NAMES[h.category] || 'היסטוריה';
    var yearsAgo = calcYearsAgo(h.year);

    var imgHtml = '';
    if (h.thumbnail) {
        imgHtml = '<div class="headline-img"><img src="'+esc(h.thumbnail)+'" alt="'+esc(h.text)+'"></div>';
    } else {
        imgHtml = '<div class="headline-img-placeholder">'
            + '<span>⚐</span>'
            + '</div>';
    }

    sec.innerHTML = '<div class="headline-wrap">'
        + imgHtml
        + '<div class="headline-body">'
        + '<span class="headline-kicker">'+esc(catName)+' · '+fmtYear(h.year)+'</span>'
        + '<h2 class="main-headline">'+esc(h.text)+'</h2>'
        + '<div class="headline-meta">'
        + '<span class="headline-year">לפני '+yearsAgo+' שנים</span>'
        + (h.source ? '<span class="meta-sep">|</span><span class="headline-source">'+esc(h.source)+'</span>' : '')
        + '</div>'
        + (h.extract ? '<p class="headline-extract">'+esc(h.extract)+'</p>' : '')
        + renderSocialPost(h.socialPost)
        + '</div></div>';
}

function renderSecondaryHeadlines(data) {
    var sec = document.getElementById('secondary-headlines');
    var headline = data.headline;
    var pool = [].concat(data.selected||[], data.events||[])
        .filter(function(e) { return !headline || e.year !== headline.year || e.text !== headline.text; });
    var picked = [], usedCats = {};
    for (var i = 0; i < pool.length && picked.length < 3; i++) {
        if (!usedCats[pool[i].category]) { picked.push(pool[i]); usedCats[pool[i].category] = true; }
    }
    for (var j = 0; j < pool.length && picked.length < 3; j++) {
        if (picked.indexOf(pool[j]) === -1) picked.push(pool[j]);
    }
    if (!picked.length) { sec.style.display='none'; return; }

    var items = picked.map(function(e, idx) {
        var catName = SECTION_NAMES[e.category]||'';
        var imgHtml = '';
        if (e.thumbnail) {
            imgHtml = '<img src="'+esc(e.thumbnail)+'" alt="" class="secondary-img" loading="lazy">';
        }
        return '<div class="secondary-card">'
            + '<div class="secondary-card-body">'
            + '<span class="secondary-badge">'+esc(catName)+'</span>'
            + imgHtml
            + '<h3 class="secondary-title">'+esc(e.text)+'</h3>'
            + '<span class="secondary-year">'+fmtYear(e.year)+' — לפני '+calcYearsAgo(e.year)+' שנים</span>'
            + '</div>'
            + (e.socialPost ? '<div class="secondary-social">'+renderSocialPost(e.socialPost)+'</div>' : '')
            + '</div>';
    });

    // Insert dividers between items
    var html = '';
    for (var k = 0; k < items.length; k++) {
        html += items[k];
        if (k < items.length - 1) {
            html += '<div class="secondary-divider"></div>';
        }
    }

    sec.innerHTML = '<div class="secondary-grid">' + html + '</div>';
}

function renderArticle(ev) {
    return '<article class="article">'
        + '<div class="article-top">'
        + '<span class="article-year-badge">'+fmtYear(ev.year)+'</span>'
        + '<span class="article-ago">לפני '+calcYearsAgo(ev.year)+' שנים</span>'
        + '</div>'
        + '<h3 class="article-title">'+esc(ev.text)+'</h3>'
        + (ev.extract ? '<p class="article-body">'+esc(ev.extract)+'</p>' : '')
        + (ev.thumbnail ? '<div class="article-img"><img src="'+esc(ev.thumbnail)+'" alt="" loading="lazy"></div>' : '')
        + renderSocialPost(ev.socialPost)
        + '<div class="article-bottom">'
        + (ev.source ? '<span class="article-source">'+esc(ev.source)+'</span>' : '')
        + '</div></article>';
}

function renderSection(cat, events) {
    var name = SECTION_NAMES[cat]||cat;
    var items = events.slice(0, 6);
    return '<div class="section-block">'
        + '<div class="section-hdr">'
        + '<span class="section-hdr-text">'+esc(name)+'</span>'
        + '</div>'
        + items.map(function(e) { return renderArticle(e); }).join('<div class="article-sep"></div>')
        + '</div>';
}

function renderSections(data) {
    var sections = data.sections || {};
    if (Object.keys(sections).length === 0 && data.events) {
        data.events.forEach(function(e) {
            var cat = e.category || 'general';
            if (!sections[cat]) sections[cat] = [];
            sections[cat].push(e);
        });
    }
    var rightCats  = ['israel', 'politics', 'military', 'religion'];
    var centerCats = ['world', 'science', 'economy'];
    var leftCats   = ['sports', 'culture', 'general'];

    document.getElementById('column-right').innerHTML =
        rightCats.filter(function(c){return sections[c] && sections[c].length;})
            .map(function(c){return renderSection(c, sections[c]);}).join('');
    document.getElementById('column-center').innerHTML =
        centerCats.filter(function(c){return sections[c] && sections[c].length;})
            .map(function(c){return renderSection(c, sections[c]);}).join('');
    document.getElementById('column-left').innerHTML =
        leftCats.filter(function(c){return sections[c] && sections[c].length;})
            .map(function(c){return renderSection(c, sections[c]);}).join('');
}

function personCard(p) {
    return '<div class="person-card">'
        + (p.thumbnail
            ? '<img src="'+esc(p.thumbnail)+'" alt="" class="person-thumb" loading="lazy">'
            : '<div class="person-thumb-placeholder">✦</div>')
        + '<div class="person-info">'
        + '<span class="person-name">'+esc(p.text)+'</span>'
        + '<span class="person-year">'+fmtYear(p.year)+'</span>'
        + '</div></div>';
}

function renderPeople(data) {
    var sec = document.getElementById('people-section');
    var births = (data.births||[]).slice(0, 10);
    var deaths = (data.deaths||[]).slice(0, 8);
    if (!births.length && !deaths.length) { sec.style.display='none'; return; }

    sec.innerHTML = '<div class="people-wrap">'
        + (births.length ? '<div class="people-col"><div class="people-hdr births-hdr">נולדו היום בהיסטוריה</div><div class="people-list">'+births.map(personCard).join('')+'</div></div>' : '')
        + (deaths.length ? '<div class="people-col"><div class="people-hdr deaths-hdr">נפטרו היום בהיסטוריה</div><div class="people-list">'+deaths.map(personCard).join('')+'</div></div>' : '')
        + '</div>';
}

function renderStats(data) {
    var s = data.stats||{};
    document.getElementById('stats-bar').textContent =
        (s.total||0)+' אירועים | '+(s.israelEvents||0)+' ישראליים | '+(s.he||0)+' עברית '+(s.en||0)+' אנגלית';
}

// ====== Main ======
function renderNewspaper(data) {
    renderDates(data);
    renderTicker(data);
    renderHolidays(data);
    renderHeadline(data);
    renderSecondaryHeadlines(data);
    renderSections(data);
    renderPeople(data);
    renderStats(data);
    document.getElementById('loading-overlay').style.display = 'none';
}

document.addEventListener('DOMContentLoaded', function() {
    loadData().then(function(data) {
        if (data) { renderNewspaper(data); }
        else {
            document.getElementById('loading-overlay').innerHTML =
                '<p style="color:#5c1a1a;font-size:1.2em;font-family:Frank Ruhl Libre,serif">לא נמצאו נתונים. ממתין לאיסוף ראשוני...</p>';
        }
        var lastGen = data ? (data.generatedAt||'') : '';
        setInterval(function() {
            loadData().then(function(fresh) {
                if (fresh && fresh.generatedAt !== lastGen) {
                    lastGen = fresh.generatedAt;
                    renderNewspaper(fresh);
                }
            });
        }, 30000);
    });
});
</script>
</body>
</html>
