<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>היום בהיסטוריה - העיתון היומי</title>
    <link rel="stylesheet" href="style.css">
    <link href="https://fonts.googleapis.com/css2?family=Heebo:wght@300;400;700;900&family=Frank+Ruhl+Libre:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>
    <div class="container">
        <!-- כותרת העיתון -->
        <header class="newspaper-header">
            <div class="date-line">
                <span class="date" id="currentDate">טוען...</span>
                <span class="hebrew-date" id="hebrewDate"></span>
                <span class="edition">העיתון היומי של ההיסטוריה | מהדורה דיגיטלית</span>
            </div>
            <h1 class="newspaper-title">היום בהיסטוריה</h1>
            <div class="subtitle" id="dailyHeadline">העיתון שמחיה את העבר - נתונים חיים מויקיפדיה</div>
            <div class="header-line"></div>

            <div class="controls">
                <button onclick="changeDate(-1)" class="control-btn nav-btn" id="btnPrev">
                    <i class="fas fa-chevron-right"></i> אתמול
                    <i class="fas fa-lock lock-icon"></i>
                </button>
                <button onclick="goToToday()" class="control-btn today-btn">
                    <i class="fas fa-calendar-day"></i> היום
                </button>
                <button onclick="changeDate(1)" class="control-btn nav-btn" id="btnNext">
                    מחר <i class="fas fa-chevron-left"></i>
                    <i class="fas fa-lock lock-icon"></i>
                </button>
            </div>
        </header>

        <!-- סרגל סטטיסטיקות -->
        <div id="statsBar" class="stats-bar" style="display:none;"></div>

        <!-- טעינה -->
        <div id="loading" class="loading-indicator">
            <div class="spinner"></div>
            <p>טוען אירועים היסטוריים...</p>
            <p class="loading-sub">מביא נתונים מויקיפדיה העברית והאנגלית</p>
        </div>

        <!-- שגיאה -->
        <div id="errorMsg" class="error-message" style="display:none;">
            <i class="fas fa-exclamation-triangle"></i>
            <p>לא הצלחנו לטעון נתונים. נסה לרענן את הדף.</p>
            <button onclick="loadEventsForDate()" class="control-btn">נסה שוב</button>
        </div>

        <!-- תוכן דינמי -->
        <div id="content" style="display: none;">
            <!-- כותרת ראשית -->
            <section id="mainHeadline" class="main-headline"></section>

            <!-- אירועים + ציוצים בצד -->
            <div class="article-with-tweet">
                <div class="article-content">
                    <section class="news-section">
                        <h3><i class="fas fa-landmark"></i> אירועים</h3>
                        <div id="eventsContent"></div>
                    </section>
                </div>
                <div class="tweet-sidebar" id="tweetsSection">
                    <h3 class="sidebar-title"><i class="fas fa-share-alt"></i> מה היו מפרסמים?</h3>
                    <div id="tweetsContent"></div>
                </div>
            </div>

            <!-- חגים ומועדים -->
            <section id="holidaysSection" class="news-section" style="display:none;">
                <h3><i class="fas fa-star"></i> חגים ואירועים מיוחדים</h3>
                <div id="holidaysContent"></div>
            </section>

            <!-- עמודות - נולדו ונפטרו -->
            <div class="columns">
                <div class="column">
                    <section class="news-section">
                        <h3><i class="fas fa-birthday-cake"></i> נולדו היום</h3>
                        <div id="birthsContent"></div>
                    </section>
                </div>
                <div class="column">
                    <section class="news-section">
                        <h3><i class="fas fa-star-of-life"></i> נפטרו היום</h3>
                        <div id="deathsContent"></div>
                    </section>
                </div>
            </div>

            <!-- חדשות היום -->
            <section id="newsSection" class="news-section" style="display:none;">
                <h3><i class="fas fa-newspaper"></i> חדשות היום</h3>
                <div id="newsContent"></div>
            </section>

            <!-- ציר זמן -->
            <section class="news-section" id="timelineSection">
                <h3><i class="fas fa-calendar-alt"></i> עוד היום בהיסטוריה</h3>
                <ul id="timelineContent" class="timeline"></ul>
            </section>

            <!-- באנר פרימיום -->
            <div id="premiumBanner" class="premium-banner">
                <div class="premium-inner">
                    <i class="fas fa-crown premium-icon"></i>
                    <div class="premium-text">
                        <h3>רוצה לראות תאריכים אחרים?</h3>
                        <p>עם מנוי פרימיום תוכל לגלול אחורה ולראות כל יום בהיסטוריה. גם תקבל גישה לארכיון מלא, תמונות היסטוריות, ותכנים בלעדיים.</p>
                        <div class="premium-features">
                            <span><i class="fas fa-check"></i> ניווט בין תאריכים</span>
                            <span><i class="fas fa-check"></i> ארכיון מלא</span>
                            <span><i class="fas fa-check"></i> ללא פרסומות</span>
                        </div>
                    </div>
                    <button class="premium-btn" onclick="handleSubscribe()">
                        <i class="fas fa-unlock"></i> הירשם עכשיו
                    </button>
                </div>
            </div>
        </div>

        <!-- פוטר -->
        <footer class="newspaper-footer">
            <div class="footer-line"></div>
            <div class="footer-content">
                <div class="footer-section">
                    <h4>אודות העיתון</h4>
                    <p>"היום בהיסטוריה" מביא לכם בכל יום את האירועים החשובים שהתרחשו בתאריך הזה לאורך השנים.</p>
                </div>
                <div class="footer-section">
                    <h4>מקור הנתונים</h4>
                    <p>הנתונים מגיעים מויקיפדיה העברית והאנגלית. התוכן מתעדכן אוטומטית בכל יום.</p>
                </div>
                <div class="footer-section">
                    <h4>צרו קשר</h4>
                    <p>הצעות, תיקונים, רעיונות?<br>history@newspaper.co.il</p>
                </div>
            </div>
            <div class="copyright">
                &copy; 2026 "היום בהיסטוריה" - כל הזכויות שמורות | נתונים: ויקיפדיה
            </div>
        </footer>
    </div>

    <script>
    // ====== Configuration ======
    const API = {
        HE: 'https://he.wikipedia.org/api/rest_v1/feed/onthisday/all',
        EN: 'https://en.wikipedia.org/api/rest_v1/feed/onthisday/all',
        HEBCAL: 'https://www.hebcal.com/converter'
    };

    const LIMITS = { EVENTS: 15, BIRTHS: 15, DEATHS: 12, TWEETS: 4 };

    // ====== State ======
    let currentDate = new Date();
    let allData = null;
    let isSubscriber = localStorage.getItem('newspaper_sub') === 'true';

    // Allow ?subscribe=true for testing
    if (new URLSearchParams(window.location.search).get('subscribe') === 'true') {
        localStorage.setItem('newspaper_sub', 'true');
        isSubscriber = true;
    }

    // ====== Helpers ======
    function pad2(n) { return String(n).padStart(2, '0'); }

    function escapeHtml(text) {
        if (!text) return '';
        const el = document.createElement('span');
        el.textContent = text;
        return el.innerHTML;
    }

    function yearsAgo(year) {
        if (!year) return '';
        const diff = currentDate.getFullYear() - year;
        if (diff <= 0) return '';
        if (diff === 1) return 'לפני שנה';
        return `לפני ${diff} שנים`;
    }

    function formatNumber(num) {
        return num >= 1000 ? (num / 1000).toFixed(1) + 'K' : String(num);
    }

    // ====== Data Fetching ======

    // Strategy: Try pre-built today.json first (server-side enriched data),
    // then fall back to live Wikipedia API calls

    async function loadFromCachedJson() {
        const todayStr = currentDate.toISOString().slice(0, 10);
        const resp = await fetch('today.json?_=' + Date.now());
        if (!resp.ok) throw new Error('No cached data');
        const data = await resp.json();
        if (data.date !== todayStr) throw new Error('Cached data is stale');
        // Normalize format for renderer
        if (!data.sourceStats) {
            data.sourceStats = data.stats || { he: 0, en: 0 };
        }
        console.log('Loaded from today.json (server-enriched data)');
        return data;
    }

    async function fetchWikiAPI(baseUrl, month, day) {
        const url = `${baseUrl}/${pad2(month)}/${pad2(day)}`;
        const resp = await fetch(url, {
            headers: { 'Api-User-Agent': 'HistoricalNewspaper/1.0 (educational project)' }
        });
        if (!resp.ok) throw new Error(`HTTP ${resp.status}`);
        return resp.json();
    }

    function processEntry(entry, lang) {
        const page = (entry.pages || [])[0] || {};
        return {
            year: entry.year || 0,
            text: entry.text || '',
            lang: lang,
            url: (page.content_urls && page.content_urls.desktop && page.content_urls.desktop.page) || null,
            extract: page.extract || null,
            thumbnail: (page.thumbnail && page.thumbnail.source) || null,
            pageTitle: page.title || ''
        };
    }

    async function loadFromLiveAPIs() {
        const m = currentDate.getMonth() + 1;
        const d = currentDate.getDate();
        const y = currentDate.getFullYear();

        const [heRes, enRes, hebRes] = await Promise.allSettled([
            fetchWikiAPI(API.HE, m, d),
            fetchWikiAPI(API.EN, m, d),
            fetch(`${API.HEBCAL}?cfg=json&gy=${y}&gm=${m}&gd=${d}&g2h=1`).then(r => r.json())
        ]);

        const he = heRes.status === 'fulfilled' ? heRes.value : null;
        const en = enRes.status === 'fulfilled' ? enRes.value : null;
        const heb = hebRes.status === 'fulfilled' ? hebRes.value : null;

        if (!he && !en) throw new Error('No data sources available');

        const data = {
            events: [], births: [], deaths: [],
            selected: [], holidays: [], socialPosts: [], news: [],
            hebrewDate: (heb && heb.hebrew) || '',
            sourceStats: { he: 0, en: 0 }
        };

        function addUnique(target, source, lang) {
            const existingYears = new Set(target.map(e => e.year));
            let added = 0;
            for (const e of source) {
                if (!existingYears.has(e.year)) {
                    target.push(processEntry(e, lang));
                    existingYears.add(e.year);
                    added++;
                }
            }
            return added;
        }

        if (he) {
            for (const cat of ['events', 'births', 'deaths', 'selected', 'holidays']) {
                for (const item of (he[cat] || [])) {
                    data[cat].push(processEntry(item, 'he'));
                    data.sourceStats.he++;
                }
            }
        }

        if (en) {
            for (const cat of ['events', 'births', 'deaths', 'selected', 'holidays']) {
                data.sourceStats.en += addUnique(data[cat], en[cat] || [], 'en');
            }
        }

        data.events.sort((a, b) => b.year - a.year);
        data.births.sort((a, b) => b.year - a.year);
        data.deaths.sort((a, b) => b.year - a.year);

        console.log('Loaded from live Wikipedia APIs (fallback)');
        return data;
    }

    async function loadData() {
        // Try cached server-enriched data first (translated, with social posts)
        try {
            return await loadFromCachedJson();
        } catch (e) {
            console.log('Cached data unavailable, trying live APIs...', e.message);
        }
        // Fallback to live Wikipedia API calls
        return await loadFromLiveAPIs();
    }

    // ====== Date Display ======
    function updateDateDisplay() {
        const opts = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
        document.getElementById('currentDate').textContent =
            currentDate.toLocaleDateString('he-IL', opts);
    }

    // ====== Date Navigation ======
    function changeDate(days) {
        if (!isSubscriber) {
            showPremiumPrompt();
            return;
        }
        currentDate = new Date(currentDate.getTime() + days * 86400000);
        updateDateDisplay();
        loadEventsForDate();
    }

    function goToToday() {
        currentDate = new Date();
        updateDateDisplay();
        loadEventsForDate();
    }

    function showPremiumPrompt() {
        const banner = document.getElementById('premiumBanner');
        if (banner) {
            banner.classList.add('highlight');
            banner.scrollIntoView({ behavior: 'smooth', block: 'center' });
            setTimeout(() => banner.classList.remove('highlight'), 2000);
        }
    }

    function handleSubscribe() {
        alert('מערכת המנויים בבנייה. בקרוב תוכל להירשם!');
    }

    // ====== Main Loader ======
    async function loadEventsForDate() {
        document.getElementById('loading').style.display = 'block';
        document.getElementById('content').style.display = 'none';
        document.getElementById('errorMsg').style.display = 'none';
        document.getElementById('statsBar').style.display = 'none';

        try {
            allData = await loadData();

            // Update Hebrew date
            if (allData.hebrewDate) {
                document.getElementById('hebrewDate').textContent = allData.hebrewDate;
            }

            document.getElementById('loading').style.display = 'none';
            document.getElementById('content').style.display = 'block';
            document.getElementById('statsBar').style.display = '';
            renderAll();
        } catch (err) {
            console.error('Fetch error:', err);
            document.getElementById('loading').style.display = 'none';
            document.getElementById('errorMsg').style.display = 'flex';
        }
    }

    // ====== Render ======
    function renderAll() {
        if (!allData) return;
        renderStatsBar();
        renderMainHeadline();
        renderEvents();
        renderBirths();
        renderDeaths();
        renderTweets();
        renderHolidays();
        renderNews();
        renderTimeline();
    }

    function renderStatsBar() {
        const bar = document.getElementById('statsBar');
        const total = allData.events.length + allData.births.length + allData.deaths.length;
        bar.innerHTML = `
            <span><i class="fas fa-landmark"></i> ${allData.events.length} אירועים</span>
            <span><i class="fas fa-birthday-cake"></i> ${allData.births.length} לידות</span>
            <span><i class="fas fa-star-of-life"></i> ${allData.deaths.length} פטירות</span>
            <span class="stats-sources">
                <i class="fas fa-database"></i>
                ${allData.sourceStats.he} מעברית | ${allData.sourceStats.en} מאנגלית
            </span>
        `;
    }

    function renderMainHeadline() {
        const el = document.getElementById('mainHeadline');
        // Prefer selected events, fallback to regular events
        const pool = allData.selected.length > 0 ? allData.selected : allData.events;
        if (pool.length === 0) {
            el.innerHTML = '<h2>לא נמצאו אירועים בולטים לתאריך זה</h2>';
            return;
        }

        // Pick one with a thumbnail, or the first
        const ev = pool.find(e => e.thumbnail) || pool[0];
        const ago = yearsAgo(ev.year);
        const langBadge = ev.lang === 'en' ? '<span class="lang-tag">EN</span>' : '';

        const imgHtml = ev.thumbnail
            ? `<div class="headline-image-wrap">
                 <img src="${escapeHtml(ev.thumbnail)}" alt="" class="headline-image"
                      onerror="this.parentElement.style.display='none'">
               </div>`
            : '';

        el.innerHTML = `
            <div class="headline-category">אירוע מרכזי ${langBadge}</div>
            <div class="headline-layout">
                <div class="headline-text">
                    <h2>${escapeHtml(String(ev.year))} - ${escapeHtml(ev.text)}</h2>
                    <div class="headline-meta">
                        <span class="byline"><i class="fas fa-book"></i> ויקיפדיה</span>
                        <span class="time">${ago ? '&#128336; ' + ago : ''}</span>
                    </div>
                    ${ev.extract ? `<p class="headline-extract">${escapeHtml(ev.extract)}</p>` : ''}
                    ${ev.url ? `<a href="${escapeHtml(ev.url)}" target="_blank" rel="noopener" class="read-more">קרא עוד בויקיפדיה &larr;</a>` : ''}
                </div>
                ${imgHtml}
            </div>
        `;

        // Update subtitle
        const sub = ev.text.length > 80 ? ev.text.substring(0, 80) + '...' : ev.text;
        document.getElementById('dailyHeadline').textContent = `${ago} | ${sub}`;
    }

    function renderEvents() {
        const container = document.getElementById('eventsContent');
        const events = allData.events.slice(0, LIMITS.EVENTS);

        if (events.length === 0) {
            container.innerHTML = '<p class="no-events">לא נמצאו אירועים.</p>';
            return;
        }

        container.innerHTML = events.map(ev => {
            const ago = yearsAgo(ev.year);
            const langBadge = ev.lang === 'en' ? ' <span class="lang-tag">EN</span>' : '';
            const thumb = ev.thumbnail
                ? `<img src="${escapeHtml(ev.thumbnail)}" class="event-thumb" alt="" onerror="this.style.display='none'">`
                : '';
            return `
                <article class="news-item">
                    <div class="event-year-badge">${ev.year}</div>
                    <div class="event-body">
                        ${thumb}
                        <div class="event-text">
                            <h4>${escapeHtml(ev.text)}${langBadge}</h4>
                            <p class="event-meta">
                                ${ago}
                                ${ev.url ? ` | <a href="${escapeHtml(ev.url)}" target="_blank" rel="noopener" class="item-link">קרא עוד</a>` : ''}
                            </p>
                        </div>
                    </div>
                </article>
            `;
        }).join('');
    }

    function renderBirths() {
        const container = document.getElementById('birthsContent');
        const births = allData.births.slice(0, LIMITS.BIRTHS);
        if (births.length === 0) {
            container.innerHTML = '<p class="no-events">לא נמצאו נתונים.</p>';
            return;
        }

        container.innerHTML = '<div class="birthdays">' +
            births.map(b => {
                const age = currentDate.getFullYear() - b.year;
                const thumb = b.thumbnail
                    ? `<img src="${escapeHtml(b.thumbnail)}" class="person-thumb" alt="" onerror="this.outerHTML='<div class=\\'person-thumb-placeholder\\'><i class=\\'fas fa-user\\'></i></div>'">`
                    : '<div class="person-thumb-placeholder"><i class="fas fa-user"></i></div>';
                const langBadge = b.lang === 'en' ? ' <span class="lang-tag">EN</span>' : '';
                return `<div class="birthday-item person-card">
                    ${thumb}
                    <div class="person-info">
                        ${b.url ? `<a href="${escapeHtml(b.url)}" target="_blank" rel="noopener">` : ''}
                        <strong>${escapeHtml(b.text)}</strong>${langBadge}
                        ${b.url ? '</a>' : ''}
                        <span class="person-year">(${b.year})${age > 0 ? ` - בן/בת ${age}` : ''}</span>
                    </div>
                </div>`;
            }).join('') +
            '</div>';
    }

    function renderDeaths() {
        const container = document.getElementById('deathsContent');
        const deaths = allData.deaths.slice(0, LIMITS.DEATHS);
        if (deaths.length === 0) {
            container.innerHTML = '<p class="no-events">לא נמצאו נתונים.</p>';
            return;
        }

        container.innerHTML = '<div class="birthdays deaths-list">' +
            deaths.map(d => {
                const thumb = d.thumbnail
                    ? `<img src="${escapeHtml(d.thumbnail)}" class="person-thumb" alt="" onerror="this.outerHTML='<div class=\\'person-thumb-placeholder\\'><i class=\\'fas fa-user\\'></i></div>'">`
                    : '<div class="person-thumb-placeholder"><i class="fas fa-user"></i></div>';
                const langBadge = d.lang === 'en' ? ' <span class="lang-tag">EN</span>' : '';
                return `<div class="birthday-item person-card">
                    ${thumb}
                    <div class="person-info">
                        ${d.url ? `<a href="${escapeHtml(d.url)}" target="_blank" rel="noopener">` : ''}
                        <strong>${escapeHtml(d.text)}</strong>${langBadge}
                        ${d.url ? '</a>' : ''}
                        <span class="person-year">(${d.year})</span>
                    </div>
                </div>`;
            }).join('') +
            '</div>';
    }

    function renderTweets() {
        const container = document.getElementById('tweetsContent');
        const section = document.getElementById('tweetsSection');

        // Use server-generated social posts if available (from DeepSeek)
        const serverPosts = allData.socialPosts || [];
        if (serverPosts.length > 0) {
            section.style.display = '';
            const platformIcons = {
                twitter: { icon: 'fab fa-x-twitter', color: '#000' },
                facebook: { icon: 'fab fa-facebook', color: '#1877f2' },
                instagram: { icon: 'fab fa-instagram', color: '#e4405f' }
            };
            container.innerHTML = serverPosts.slice(0, LIMITS.TWEETS).map(post => {
                const p = platformIcons[post.platform] || platformIcons.twitter;
                const initial = (post.author || '?').charAt(0);
                const ago = yearsAgo(post.year);
                return `
                    <div class="historical-tweet">
                        <div class="tweet-header">
                            <div class="tweet-avatar-placeholder" style="background-color:${p.color}">${escapeHtml(initial)}</div>
                            <div class="tweet-author">
                                <strong>${escapeHtml(post.author || '')}</strong>
                                <span>${escapeHtml(post.handle || '')}</span>
                            </div>
                            <i class="${p.icon} tweet-icon" style="color:${p.color}"></i>
                        </div>
                        <div class="tweet-content">
                            ${escapeHtml(post.content || '')}
                            ${ago ? `<div class="tweet-ago">${ago}</div>` : ''}
                        </div>
                        <div class="tweet-stats">
                            <span><i class="fas fa-heart"></i> ${formatNumber(post.likes || 0)}</span>
                            <span><i class="fas fa-retweet"></i> ${formatNumber(post.retweets || 0)}</span>
                            <span><i class="fas fa-comment"></i> ${formatNumber(post.replies || 0)}</span>
                        </div>
                    </div>
                `;
            }).join('');
            return;
        }

        // Fallback: generate posts from event data (client-side)
        const sources = [
            ...allData.selected.slice(0, 2),
            ...allData.events.filter(e => e.lang === 'he').slice(0, 4),
            ...allData.births.filter(b => b.lang === 'he').slice(0, 2),
            ...allData.events.slice(0, 4)
        ];

        if (sources.length < 2) {
            section.style.display = 'none';
            return;
        }
        section.style.display = '';

        const picks = [];
        const usedYears = new Set();
        for (const s of sources) {
            if (!usedYears.has(s.year) && picks.length < LIMITS.TWEETS) {
                picks.push(s);
                usedYears.add(s.year);
            }
        }

        const platforms = [
            { icon: 'fab fa-x-twitter', name: 'X', color: '#000' },
            { icon: 'fab fa-facebook', name: 'Facebook', color: '#1877f2' },
            { icon: 'fab fa-instagram', name: 'Instagram', color: '#e4405f' },
            { icon: 'fab fa-x-twitter', name: 'X', color: '#000' }
        ];

        container.innerHTML = picks.map((ev, i) => {
            const platform = platforms[i % platforms.length];
            const nameText = ev.text || '';
            const name = nameText.split(/[,\-–:]/)[0].trim().substring(0, 30) || 'Unknown';
            const initial = name.charAt(0).toUpperCase() || '?';
            const cleanHandle = name.replace(/\s+/g, '').replace(/[^\w\u0590-\u05FF]/g, '').substring(0, 15);
            const handle = '@' + (cleanHandle || 'history');
            const likes = Math.floor(Math.random() * 12000) + 500;
            const shares = Math.floor(likes * 0.35);
            const ago = yearsAgo(ev.year);

            const avatarHtml = ev.thumbnail
                ? `<img src="${escapeHtml(ev.thumbnail)}" class="tweet-avatar" alt=""
                       onerror="this.outerHTML='<div class=\\'tweet-avatar-placeholder\\' style=\\'background-color:${platform.color}\\'>${initial}</div>'">`
                : `<div class="tweet-avatar-placeholder" style="background-color:${platform.color}">${initial}</div>`;

            return `
                <div class="historical-tweet">
                    <div class="tweet-header">
                        ${avatarHtml}
                        <div class="tweet-author">
                            <strong>${escapeHtml(name)}</strong>
                            <span>${escapeHtml(handle)}</span>
                        </div>
                        <i class="${platform.icon} tweet-icon" style="color:${platform.color}"></i>
                    </div>
                    <div class="tweet-content">
                        "${escapeHtml(ev.text)}"
                        ${ago ? `<div class="tweet-ago">${ago}</div>` : ''}
                    </div>
                    <div class="tweet-stats">
                        <span><i class="fas fa-heart"></i> ${formatNumber(likes)}</span>
                        <span><i class="fas fa-retweet"></i> ${formatNumber(shares)}</span>
                        <span><i class="fas fa-comment"></i> ${formatNumber(Math.floor(shares * 0.3))}</span>
                    </div>
                </div>
            `;
        }).join('');
    }

    function renderHolidays() {
        const section = document.getElementById('holidaysSection');
        const container = document.getElementById('holidaysContent');
        if (!allData.holidays || allData.holidays.length === 0) {
            section.style.display = 'none';
            return;
        }
        section.style.display = '';
        container.innerHTML = '<div class="holidays-list">' +
            allData.holidays.map(h => {
                const langBadge = h.lang === 'en' ? ' <span class="lang-tag">EN</span>' : '';
                return `<div class="holiday-item">
                    <i class="fas fa-star holiday-star"></i>
                    <span>${escapeHtml(h.text)}${langBadge}</span>
                    ${h.url ? `<a href="${escapeHtml(h.url)}" target="_blank" rel="noopener" class="item-link">פרטים</a>` : ''}
                </div>`;
            }).join('') +
            '</div>';
    }

    function renderNews() {
        const section = document.getElementById('newsSection');
        const container = document.getElementById('newsContent');
        const news = allData.news || [];
        if (news.length === 0) {
            section.style.display = 'none';
            return;
        }
        section.style.display = '';
        container.innerHTML = '<div class="news-list">' +
            news.slice(0, 6).map(n => `
                <div class="news-card">
                    <a href="${escapeHtml(n.url)}" target="_blank" rel="noopener">
                        <strong>${escapeHtml(n.title)}</strong>
                    </a>
                    ${n.summary ? `<p class="news-summary">${escapeHtml(n.summary.substring(0, 120))}${n.summary.length > 120 ? '...' : ''}</p>` : ''}
                    <span class="news-source"><i class="fas fa-external-link-alt"></i> ${escapeHtml(n.source || 'ynet')}</span>
                </div>
            `).join('') +
            '</div>';
    }

    function renderTimeline() {
        const section = document.getElementById('timelineSection');
        const container = document.getElementById('timelineContent');
        const remaining = allData.events.slice(LIMITS.EVENTS);
        if (remaining.length === 0) {
            section.style.display = 'none';
            return;
        }
        section.style.display = '';

        container.innerHTML = remaining.slice(0, 20).reverse().map(ev => {
            const langBadge = ev.lang === 'en' ? ' <span class="lang-tag">EN</span>' : '';
            return `<li><strong>${ev.year}</strong> - ${escapeHtml(ev.text)}${langBadge}</li>`;
        }).join('');
    }

    // ====== Init ======
    document.addEventListener('DOMContentLoaded', function () {
        // Update nav buttons based on subscription
        if (!isSubscriber) {
            document.querySelectorAll('.nav-btn').forEach(btn => {
                btn.classList.add('locked');
            });
        } else {
            document.querySelectorAll('.lock-icon').forEach(icon => {
                icon.style.display = 'none';
            });
            const banner = document.getElementById('premiumBanner');
            if (banner) banner.style.display = 'none';
        }

        currentDate = new Date();
        updateDateDisplay();
        loadEventsForDate();
    });
    </script>
</body>
</html>
