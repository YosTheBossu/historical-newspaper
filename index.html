<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>×“×‘×¨×™ ×”×™××™× â€” ×¢×™×ª×•×Ÿ ×”×™×¡×˜×•×¨×™ ×™×•××™</title>
    <link rel="stylesheet" href="style.css">
    <link href="https://fonts.googleapis.com/css2?family=David+Libre:wght@400;500;700&family=Frank+Ruhl+Libre:wght@300;400;500;700;900&family=Heebo:wght@300;400;500;700;800;900&display=swap" rel="stylesheet">
</head>
<body>
    <!-- Top red accent bar -->
    <div class="top-bar">
        <div class="top-bar-inner">
            <span>×’×™×œ×™×•×Ÿ ××™×•×—×“ â€” ×”×™×•× ×‘×”×™×¡×˜×•×¨×™×”</span>
            <span id="edition-text">××”×“×•×¨×ª ×‘×•×§×¨</span>
        </div>
    </div>

    <!-- Masthead -->
    <header class="masthead">
        <div class="masthead-inner">
            <div class="masthead-date masthead-date-right" id="hebrew-date-wrap">
                <span class="masthead-date-label">×œ×•×— ×¢×‘×¨×™</span>
                <span id="hebrew-date"></span>
            </div>
            <div class="masthead-center">
                <h1 class="newspaper-title">×“×‘×¨×™ ×”×™××™×</h1>
                <div class="newspaper-subtitle">××™×¨×•×¢×™× ×©×¢×™×¦×‘×• ××ª ×™×©×¨××œ ×•×”×¢×•×œ× â€” ×”×™×•× ×‘×”×™×¡×˜×•×¨×™×”</div>
            </div>
            <div class="masthead-date masthead-date-left" id="gregorian-date-wrap">
                <span class="masthead-date-label">×œ×•×— ×’×¨×’×•×¨×™×× ×™</span>
                <span id="gregorian-date"></span>
            </div>
        </div>
        <div class="masthead-rule"></div>
    </header>

    <!-- Breaking news ticker -->
    <div class="ticker-bar">
        <span class="ticker-label">×¤×œ××©×‘×§</span>
        <div class="ticker-track">
            <div class="ticker-scroll" id="ticker-scroll"></div>
        </div>
    </div>

    <!-- Holiday Strip -->
    <div class="holiday-strip" id="holiday-strip" style="display:none">
        <span class="holiday-strip-label">×—×’×™× ×”×™×•× ×‘×”×™×¡×˜×•×¨×™×”</span>
        <div id="holiday-tags"></div>
    </div>

    <!-- Main headline -->
    <section class="headline-section" id="headline-section"></section>

    <!-- Secondary headlines -->
    <section class="secondary-headlines" id="secondary-headlines"></section>

    <div class="section-rule"></div>

    <!-- Three-column newspaper body -->
    <main class="newspaper-body" id="newspaper-body">
        <div class="column column-right" id="column-right"></div>
        <div class="column-divider"></div>
        <div class="column column-center" id="column-center"></div>
        <div class="column-divider"></div>
        <div class="column column-left" id="column-left"></div>
    </main>

    <!-- Births & Deaths -->
    <section class="people-section" id="people-section"></section>

    <!-- Footer -->
    <footer class="newspaper-footer">
        <div class="footer-inner">
            <span>Â© ×“×‘×¨×™ ×”×™××™× â€” ×¢×™×ª×•×Ÿ ×”×™×¡×˜×•×¨×™ ×™×•××™ | × ×ª×•× ×™× ××•×•×™×§×™×¤×“×™×”</span>
            <span id="stats-bar"></span>
        </div>
    </footer>

    <!-- Loading overlay -->
    <div class="loading-overlay" id="loading-overlay">
        <div class="loading-spinner"></div>
        <p>×˜×•×¢×Ÿ ××ª ×’×™×œ×™×•×Ÿ ×”×™×•×...</p>
    </div>

<script>
// ====== Section Config ======
var SECTION_NAMES = {
    israel:'×™×©×¨××œ', politics:'××“×™× ×™', military:'×¦×‘××™ ×•×‘×˜×—×•× ×™',
    science:'××“×¢ ×•×˜×›× ×•×œ×•×’×™×”', culture:'×ª×¨×‘×•×ª ×•×‘×™×“×•×¨', sports:'×¡×¤×•×¨×˜',
    economy:'×›×œ×›×œ×”', religion:'×“×ª ×•××¡×•×¨×ª', world:'×¢×•×œ××™', general:'×›×œ×œ×™'
};
var SECTION_COLORS = {
    israel:'#0038b8', politics:'#8B0000', military:'#2F4F4F',
    science:'#006400', culture:'#800080', sports:'#FF8C00',
    economy:'#8B4513', religion:'#4B0082', world:'#191970', general:'#444'
};

// ====== Data Loading ======
function loadData() {
    return fetch('today.json?t=' + Date.now())
        .then(function(r) { if (!r.ok) throw new Error(); return r.json(); })
        .then(function(d) { if (d && d.events && d.events.length > 0) return d; throw new Error(); })
        .catch(function() {
            return fetch('example-events.json')
                .then(function(r2) { return r2.ok ? r2.json() : null; })
                .catch(function() { return null; });
        });
}

// ====== Helpers ======
function fmtNum(n) { return n >= 1000 ? (n/1000).toFixed(1)+'K' : String(n||0); }
function fmtYear(y) { return y < 0 ? Math.abs(y)+' ×œ×¤× ×”"×¡' : String(y); }
function calcYearsAgo(y) { return Math.abs(new Date().getFullYear() - y); }
function esc(s) { if (!s) return ''; var d=document.createElement('div'); d.textContent=String(s); return d.innerHTML; }
function catColor(cat) { return SECTION_COLORS[cat] || '#d32f2f'; }

// ====== Render Functions ======
function renderDates(data) {
    document.getElementById('hebrew-date').textContent = data.hebrewDate || '';
    if (data.date) {
        var d = new Date(data.date + 'T00:00:00');
        document.getElementById('gregorian-date').textContent =
            d.toLocaleDateString('he-IL',{weekday:'long',year:'numeric',month:'long',day:'numeric'});
    }
    var h = new Date().getHours();
    document.getElementById('edition-text').textContent =
        h < 12 ? '××”×“×•×¨×ª ×‘×•×§×¨' : h < 18 ? '××”×“×•×¨×ª ×¦×”×¨×™×™×' : '××”×“×•×¨×ª ×¢×¨×‘';
}

function renderTicker(data) {
    var el = document.getElementById('ticker-scroll');
    var items = [].concat(data.selected||[], data.events||[]).slice(0, 14);
    var html = items.map(function(e) {
        var color = catColor(e.category);
        return '<span class="ticker-item"><b style="color:'+color+'">'+fmtYear(e.year)+'</b>: '+esc(e.text)+'</span>';
    }).join('<span class="ticker-sep">â—†</span>');
    el.innerHTML = html + html; // duplicate for seamless scroll
}

function renderHolidays(data) {
    var holidays = data.holidays || [];
    var strip = document.getElementById('holiday-strip');
    var tagsEl = document.getElementById('holiday-tags');
    if (!holidays.length) { strip.style.display = 'none'; return; }
    strip.style.display = 'flex';
    var HOLIDAY_EMOJIS = { religion: 'âœ¡ï¸', world: 'ğŸŒ', general: 'ğŸ“…', culture: 'ğŸ­', military: 'ğŸ•Šï¸' };
    tagsEl.innerHTML = holidays.map(function(h) {
        var emoji = HOLIDAY_EMOJIS[h.category] || 'ğŸ“…';
        return '<span class="holiday-tag">'+emoji+' '+esc(h.text || h.title)+'</span>';
    }).join('');
}

function renderSocialPost(post) {
    if (!post) return '';
    var icons = {twitter:'ğ•', facebook:'f', instagram:'ğŸ“·'};
    var pName = post.platform || 'twitter';
    return '<div class="social-embed '+pName+'">'
        + '<span class="social-imagined-label">×¦×™×•×¥ ××“×•××” ××”×¢×‘×¨</span>'
        + '<div class="social-header">'
        + '<span class="social-icon">'+(icons[pName]||'ğŸ’¬')+'</span>'
        + '<span class="social-author">'+esc(post.author)+'</span>'
        + '<span class="social-handle dir-ltr">'+esc(post.handle)+'</span>'
        + '</div>'
        + '<p class="social-text">'+esc(post.content)+'</p>'
        + '<div class="social-stats">'
        + '<span>â¤ï¸ '+fmtNum(post.likes)+'</span>'
        + '<span>ğŸ”„ '+fmtNum(post.retweets)+'</span>'
        + '<span>ğŸ’¬ '+fmtNum(post.replies)+'</span>'
        + '</div></div>';
}

function renderHeadline(data) {
    var sec = document.getElementById('headline-section');
    var h = data.headline;
    if (!h) { sec.innerHTML = '<h2 class="main-headline" style="padding:24px">×“×£ ×—×œ×§</h2>'; return; }
    var catName = SECTION_NAMES[h.category] || '×”×™×¡×˜×•×¨×™×”';
    var color = catColor(h.category);
    var yearsAgo = calcYearsAgo(h.year);

    var imgHtml = '';
    if (h.thumbnail) {
        imgHtml = '<div class="headline-img"><img src="'+esc(h.thumbnail)+'" alt="'+esc(h.text)+'"></div>';
    } else {
        imgHtml = '<div class="headline-img-placeholder" style="background: linear-gradient(135deg, '+color+'22, '+color+'44)">'
            + '<span style="font-size:6rem;opacity:0.35">ğŸ“°</span>'
            + '</div>';
    }

    sec.innerHTML = '<div class="headline-wrap">'
        + imgHtml
        + '<div class="headline-body">'
        + '<span class="headline-kicker" style="background:'+color+'">'+esc(catName)+' Â· '+fmtYear(h.year)+'</span>'
        + '<h2 class="main-headline">'+esc(h.text)+'</h2>'
        + '<div class="headline-meta">'
        + '<span class="headline-year" style="background:'+color+'">×œ×¤× ×™ '+yearsAgo+' ×©× ×™×</span>'
        + (h.source ? '<span class="meta-sep">|</span><span class="headline-source">'+esc(h.source)+'</span>' : '')
        + '</div>'
        + (h.extract ? '<p class="headline-extract">'+esc(h.extract)+'</p>' : '')
        + renderSocialPost(h.socialPost)
        + '</div></div>';
}

function renderSecondaryHeadlines(data) {
    var sec = document.getElementById('secondary-headlines');
    var headline = data.headline;
    var pool = [].concat(data.selected||[], data.events||[])
        .filter(function(e) { return !headline || e.year !== headline.year || e.text !== headline.text; });
    var picked = [], usedCats = {};
    for (var i = 0; i < pool.length && picked.length < 3; i++) {
        if (!usedCats[pool[i].category]) { picked.push(pool[i]); usedCats[pool[i].category] = true; }
    }
    for (var j = 0; j < pool.length && picked.length < 3; j++) {
        if (picked.indexOf(pool[j]) === -1) picked.push(pool[j]);
    }
    if (!picked.length) { sec.style.display='none'; return; }

    sec.innerHTML = '<div class="secondary-grid">' + picked.map(function(e) {
        var catName = SECTION_NAMES[e.category]||'';
        var color = catColor(e.category);
        var imgHtml = '';
        if (e.thumbnail) {
            imgHtml = '<img src="'+esc(e.thumbnail)+'" alt="" class="secondary-img" loading="lazy">';
        } else {
            imgHtml = '<div class="secondary-img-placeholder" style="background:'+color+'18">'
                + '<span>ğŸ“·</span></div>';
        }
        return '<div class="secondary-card" style="border-top-color:'+color+'">'
            + imgHtml
            + '<div class="secondary-card-body">'
            + '<span class="secondary-badge" style="background:'+color+'">'+esc(catName)+'</span>'
            + '<h3 class="secondary-title">'+esc(e.text)+'</h3>'
            + '<span class="secondary-year" style="color:'+color+'">'+fmtYear(e.year)+' â€” ×œ×¤× ×™ '+calcYearsAgo(e.year)+' ×©× ×™×</span>'
            + '</div>'
            + (e.socialPost ? '<div class="secondary-social">'+renderSocialPost(e.socialPost)+'</div>' : '')
            + '</div>';
    }).join('') + '</div>';
}

function renderArticle(ev) {
    var color = catColor(ev.category);
    return '<article class="article">'
        + '<div class="article-top">'
        + '<span class="article-year-badge" style="background:'+color+'">'+fmtYear(ev.year)+'</span>'
        + '<span class="article-ago">×œ×¤× ×™ '+calcYearsAgo(ev.year)+' ×©× ×™×</span>'
        + '</div>'
        + '<h3 class="article-title">'+esc(ev.text)+'</h3>'
        + (ev.extract ? '<p class="article-body">'+esc(ev.extract)+'</p>' : '')
        + (ev.thumbnail ? '<div class="article-img"><img src="'+esc(ev.thumbnail)+'" alt="" loading="lazy"></div>' : '')
        + renderSocialPost(ev.socialPost)
        + '<div class="article-bottom">'
        + (ev.source ? '<span class="article-source">'+esc(ev.source)+'</span>' : '')
        + '</div></article>';
}

function renderSection(cat, events) {
    var color = SECTION_COLORS[cat]||'#333';
    var name = SECTION_NAMES[cat]||cat;
    var items = events.slice(0, 6);
    return '<div class="section-block">'
        + '<div class="section-hdr" style="color:'+color+'">'
        + '<span class="section-hdr-text">'+esc(name)+'</span>'
        + '<span class="section-count">'+events.length+' ××™×¨×•×¢×™×</span>'
        + '</div>'
        + items.map(function(e) { return renderArticle(e); }).join('<div class="article-sep"></div>')
        + '</div>';
}

function renderSections(data) {
    var sections = data.sections || {};
    // Build from events if sections not provided
    if (Object.keys(sections).length === 0 && data.events) {
        data.events.forEach(function(e) {
            var cat = e.category || 'general';
            if (!sections[cat]) sections[cat] = [];
            sections[cat].push(e);
        });
    }
    // Three-column distribution
    var rightCats  = ['israel', 'politics', 'military', 'religion'];
    var centerCats = ['world', 'science', 'economy'];
    var leftCats   = ['sports', 'culture', 'general'];

    document.getElementById('column-right').innerHTML =
        rightCats.filter(function(c){return sections[c] && sections[c].length;})
            .map(function(c){return renderSection(c, sections[c]);}).join('');
    document.getElementById('column-center').innerHTML =
        centerCats.filter(function(c){return sections[c] && sections[c].length;})
            .map(function(c){return renderSection(c, sections[c]);}).join('');
    document.getElementById('column-left').innerHTML =
        leftCats.filter(function(c){return sections[c] && sections[c].length;})
            .map(function(c){return renderSection(c, sections[c]);}).join('');
}

function personCard(p) {
    return '<div class="person-card">'
        + (p.thumbnail
            ? '<img src="'+esc(p.thumbnail)+'" alt="" class="person-thumb" loading="lazy">'
            : '<div class="person-thumb-placeholder">ğŸ‘¤</div>')
        + '<div class="person-info">'
        + '<span class="person-name">'+esc(p.text)+'</span>'
        + '<span class="person-year">'+fmtYear(p.year)+'</span>'
        + '</div></div>';
}

function renderPeople(data) {
    var sec = document.getElementById('people-section');
    var births = (data.births||[]).slice(0, 10);
    var deaths = (data.deaths||[]).slice(0, 8);
    if (!births.length && !deaths.length) { sec.style.display='none'; return; }

    sec.innerHTML = '<div class="people-wrap">'
        + (births.length ? '<div class="people-col"><div class="people-hdr births-hdr">× ×•×œ×“×• ×”×™×•× ×‘×”×™×¡×˜×•×¨×™×”</div><div class="people-list">'+births.map(personCard).join('')+'</div></div>' : '')
        + (deaths.length ? '<div class="people-col"><div class="people-hdr deaths-hdr">× ×¤×˜×¨×• ×”×™×•× ×‘×”×™×¡×˜×•×¨×™×”</div><div class="people-list">'+deaths.map(personCard).join('')+'</div></div>' : '')
        + '</div>';
}

function renderStats(data) {
    var s = data.stats||{};
    document.getElementById('stats-bar').textContent =
        (s.total||0)+' ××™×¨×•×¢×™× | '+(s.israelEvents||0)+' ×™×©×¨××œ×™×™× | '+(s.he||0)+' ×¢×‘×¨×™×ª '+(s.en||0)+' ×× ×’×œ×™×ª | '+(s.llmProvider||'');
}

// ====== Main ======
function renderNewspaper(data) {
    renderDates(data);
    renderTicker(data);
    renderHolidays(data);
    renderHeadline(data);
    renderSecondaryHeadlines(data);
    renderSections(data);
    renderPeople(data);
    renderStats(data);
    document.getElementById('loading-overlay').style.display = 'none';
}

document.addEventListener('DOMContentLoaded', function() {
    loadData().then(function(data) {
        if (data) { renderNewspaper(data); }
        else {
            document.getElementById('loading-overlay').innerHTML =
                '<p style="color:#8B0000;font-size:1.2em">×œ× × ××¦××• × ×ª×•× ×™×. ×××ª×™×Ÿ ×œ××™×¡×•×£ ×¨××©×•× ×™...</p>';
        }
        // Auto-refresh every 30 seconds
        var lastGen = data ? (data.generatedAt||'') : '';
        setInterval(function() {
            loadData().then(function(fresh) {
                if (fresh && fresh.generatedAt !== lastGen) {
                    lastGen = fresh.generatedAt;
                    renderNewspaper(fresh);
                }
            });
        }, 30000);
    });
});
</script>
</body>
</html>
